<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Start • Kaffekatten TD</title>
  <style>
    :root{
      --bg:#0e0f12; --bg-2:#0b0c10; --panel:#141518; --edge:#2a2d32; --txt:#eaeaea; --muted:#aab; --btn:#22c55e; --btn2:#2d6; --shadow: 0 8px 28px rgba(0,0,0,0.35);
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),var(--bg-2));color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:28px auto;padding:0 18px}
    .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .title{font-weight:800;font-size:26px;letter-spacing:.3px}
    .chip{padding:4px 8px;border-radius:8px;background:#1f2937;color:#9bb;border:1px solid #2a2d32;font-size:12px}
  .hero{display:flex;gap:16px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06)); border:1px solid var(--edge); border-radius:16px; padding:16px; margin-bottom:16px; box-shadow:var(--shadow)}
  .heroLogo{width:64px;height:64px;flex:0 0 64px;background:#0b0c10;border:1px solid #2b2f36;border-radius:12px;display:grid;place-items:center}
  .heroText h1{margin:0 0 4px 0;font-size:22px}
  .heroText p{margin:0;color:#b9c}
  @media (max-width: 560px){ .hero{flex-direction:column;align-items:flex-start} .heroLogo{width:56px;height:56px} }
    .grid{display:grid;grid-template-columns: 420px 1fr; gap:18px; align-items:start}
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }
    .card{background:var(--panel);border:1px solid var(--edge);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
    label{display:block;margin:10px 0 4px;color:#cbd5e1}
    input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid #333;background:#0b0d10;color:#fff}
    .btn-primary, .btn{cursor:pointer;background:var(--btn);border:0;margin-top:12px;display:inline-block;text-align:center;text-decoration:none;color:#062; filter:saturate(1.1)}
    .btn-primary{padding:12px 16px;border-radius:12px;font-weight:700;background:var(--btn);color:#031}
  .btn-ghost{padding:12px 16px;border-radius:12px;font-weight:600;background:#1b1e24;color:#cbd5e1;border:1px solid #2a2d32; text-decoration:none; display:inline-block}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .links{display:flex;gap:10px;margin-top:12px}
    .row-btns{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    a{color:#8cf}
    .preview{background:#0b0c10;border:1px solid #333;border-radius:14px;padding:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.04)}
    .small{color:var(--muted);font-size:12px}
    canvas{image-rendering:auto}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .legend .item{display:flex;gap:8px;align-items:center;background:#101216;border:1px solid #2a2d32;padding:6px 8px;border-radius:8px;color:#bbc;font-size:12px}
  .legend .swatch{width:14px;height:14px;border-radius:4px;border:1px solid #ffffff22;box-shadow:inset 0 0 0 1px #00000055}
  .filters{display:grid;grid-template-columns: 1fr 160px 120px; gap:8px; margin:6px 0}
  .starBtn{margin-left:auto; padding:10px 12px; border-radius:10px; border:1px solid #2a2d32; background:#12151a; color:#ffdb5a; text-decoration:none; display:inline-block}
  .starBtn.active{background:#201b10; border-color:#49412a}
  </style>
  <script src="src/maps.js"></script>
  <script>
    window.onload = function() {
      function qs(s){ return document.querySelector(s); }
      var mapPreset = qs('#mapPreset');
      var difficulty = qs('#difficulty');
      var endless = qs('#endless');
      var buildMode = qs('#buildMode');
      var prev = document.getElementById('mapPrev');
      var pctx = prev.getContext('2d');
  var cbHC = document.getElementById('colorblind');
      var cbRM = document.getElementById('reducedMotion');
  // Preview view transform (zoom/pan)
  var view = { scale: 1, x: 0, y: 0 };

      // --- Helper: generate points for default maps if missing ---
      function generateLegacyPoints(id, width, height) {
        var TILE = 32;
        var COLS = Math.max(3, Math.floor(width/TILE));
        var ROWS = Math.max(3, Math.floor(height/TILE));
        var cx = function(col){ return col*TILE+TILE/2; }, cy = function(row){ return row*TILE+TILE/2; };
        var path = [];
        if(id==='ring'){
          for(var i=0;i<COLS;i++) path.push({x:cx(i),y:cy(1)});
          for(var r=2;r<ROWS-2;r++) path.push({x:cx(COLS-1),y:cy(r)});
          for(var i=COLS-1;i>=0;i--) path.push({x:cx(i),y:cy(ROWS-2)});
        } else if(id==='maze'){
          for(var i=1;i<COLS-1;i++) path.push({x:cx(i),y:cy(1)});
          for(var r=2;r<ROWS-2;r++) path.push({x:cx(COLS-2),y:cy(r)});
          for(var i=COLS-2;i>1;i--) path.push({x:cx(i),y:cy(ROWS-3)});
          for(var r=ROWS-4;r>1;r--) path.push({x:cx(2),y:cy(r)});
        }
        return path;
      }

  // Favorites helpers
  function getFavs(){ try{ return JSON.parse(localStorage.getItem('td-fav-maps-v1')||'[]')||[]; }catch(_e){ return []; } }
  function setFavs(v){ try{ localStorage.setItem('td-fav-maps-v1', JSON.stringify(v||[])); }catch(_e){} }
  function isFav(id){ return getFavs().includes(id); }
  function toggleFav(id){ var f=getFavs(); var i=f.indexOf(id); if(i===-1) f.push(id); else f.splice(i,1); setFavs(f); }
  function updateFavStar(){ try{ var favBtn=document.getElementById('btnFav'); if(!favBtn) return; var sel=document.getElementById('mapPreset'); var cur=sel?.value; var fav=isFav(cur); favBtn.classList.toggle('active', !!fav); favBtn.textContent = fav? '★ Favorit' : '☆ Favorit'; }catch(_e){} }

  // Populate map dropdown from localStorage, always include default maps, with filters
  function populateMapDropdown() {
        var maps = [];
        // Always start with defaults, then merge in custom
        var defaults = (window.Maps && window.Maps.DEFAULT_MAPS) ? window.Maps.DEFAULT_MAPS.map(function(m){ return Object.assign({}, m); }) : [];
        // Generate points for defaults if missing
        for(var i=0;i<defaults.length;i++){
          if(!Array.isArray(defaults[i].points) || defaults[i].points.length < 2){
            defaults[i].points = generateLegacyPoints(defaults[i].id, prev.width, prev.height);
          }
        }
        // Load custom maps
        var stored = (window.Maps && window.Maps.loadMaps) ? window.Maps.loadMaps() : [];
        // Remove any default maps from stored (by id)
        var customs = stored.filter(function(m){ return !defaults.some(function(d){ return d.id === m.id; }); });
  maps = defaults.concat(customs);
  // Filters
  var ft = document.getElementById('filterText'); var ftype=document.getElementById('filterType');
  var q=(ft?.value||'').trim().toLowerCase(); var tp=ftype?.value||'alla';
  maps = maps.filter(function(m){ var okText = !q || (m.name||'').toLowerCase().includes(q) || (m.description||'').toLowerCase().includes(q) || (m.id||'').includes(q); var okType = (tp==='alla') || (tp==='standard' && m.type==='default') || (tp==='egen' && m.type!=='default') || (tp==='favorit' && isFav(m.id)); return okText && okType; });
        mapPreset.innerHTML = '';
        for (var i=0; i<maps.length; i++) {
          var map = maps[i];
          var opt = document.createElement('option');
          opt.value = map.id;
          var suffix = (map.type === 'default' ? '' : ' (egen)');
          opt.textContent = map.name + suffix + (isFav(map.id) ? ' ★' : '');
          mapPreset.appendChild(opt);
        }
        // Set value to last used or first
        var KEY = 'td-settings-v1';
        var data = {};
        try { data = JSON.parse(localStorage.getItem(KEY)||'{}')||{}; } catch(e){ data={}; }
        var MapSettings = data.MapSettings || {};
        var sel = MapSettings.preset || '';
        if (!maps.some(function(m){ return m.id === sel; })) sel = maps[0] ? maps[0].id : '';
        mapPreset.value = sel;
      }
      populateMapDropdown();

      // Set other fields from localStorage if available
      var KEY = 'td-settings-v1';
      var data = {};
      try { data = JSON.parse(localStorage.getItem(KEY)||'{}')||{}; } catch(e){ data={}; }
      var MapSettings = data.MapSettings || {};
      var Settings = data.Settings || {};
      difficulty.value = String(MapSettings.difficulty||1);
      endless.checked = !!MapSettings.endless;
      buildMode.value = Settings.buildMode||'paint';

      // --- Unified scaling: scale from new game space (1200x800, PAD=24) to preview canvas (480x300) ---
      function scaleGameToPreview(pt) {
        const GAME_W=1200, GAME_H=800, PAD=24;
        // Use actual canvas resolution (after DPR scaling) to keep consistent mapping
        const PPAD=12;
        const srcW = GAME_W-2*PAD, srcH = GAME_H-2*PAD;
        const dstW = (prev?.width||480)-2*PPAD, dstH = (prev?.height||300)-2*PPAD;
        const scale = Math.min(dstW/srcW, dstH/srcH);
        return { x: ((pt.x-PAD)*scale)+PPAD, y: ((pt.y-PAD)*scale)+PPAD };
      }
  function ensurePreviewResolution(){
        if(!prev) return; const dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
        const cssW = Math.floor(prev.clientWidth||prev.width); const cssH = Math.floor(prev.clientHeight||prev.height);
        const targetW = Math.max(320, Math.floor(cssW*dpr)); const targetH = Math.max(200, Math.floor(cssH*dpr));
        if(prev.width!==targetW || prev.height!==targetH){ prev.width=targetW; prev.height=targetH; }
      }
  function drawPreview(){
        ensurePreviewResolution();
        // Use the same map list as dropdown
        var maps = [];
        var defaults = (window.Maps && window.Maps.DEFAULT_MAPS) ? window.Maps.DEFAULT_MAPS.map(function(m){ return Object.assign({}, m); }) : [];
        for(var i=0;i<defaults.length;i++){
          if(!Array.isArray(defaults[i].points) || defaults[i].points.length < 2){
            defaults[i].points = generateLegacyPoints(defaults[i].id, prev.width, prev.height);
          }
        }
        var stored = (window.Maps && window.Maps.loadMaps) ? window.Maps.loadMaps() : [];
        var customs = stored.filter(function(m){ return !defaults.some(function(d){ return d.id === m.id; }); });
        maps = defaults.concat(customs);
        var map = maps.find(function(m){ return m.id === mapPreset.value; });
        // Collect all routes; fall back to single legacy points
        var routes = [];
        if(map){
          if(Array.isArray(map.routes) && map.routes.length>0){
            for(var ri=0; ri<map.routes.length; ri++){
              var r = map.routes[ri];
              if(r && Array.isArray(r.points) && r.points.length>=2) routes.push(r);
            }
          } else if(Array.isArray(map.points) && map.points.length>=2){
            routes.push({ points: map.points });
          }
        }
        if (routes.length===0) {
          pctx.clearRect(0,0,prev.width,prev.height);
          var infoHost0=document.getElementById('mapInfo'); if(infoHost0) infoHost0.innerHTML='';
          var leg0=document.getElementById('previewLegend'); if(leg0) leg0.innerHTML='';
          return;
        }
        var tmp = document.createElement('canvas'); tmp.width=prev.width; tmp.height=prev.height; var tctx=tmp.getContext('2d');
  tctx.clearRect(0,0,tmp.width,tmp.height);
  tctx.fillStyle='#0b0b0c'; tctx.fillRect(0,0,tmp.width,tmp.height);
  // apply view transform for zoom/pan
  tctx.save(); tctx.translate(view.x, view.y); tctx.scale(view.scale, view.scale);
        var hc = !!cbHC?.checked;
  var palette=['#4ade80','#60a5fa','#f472b6','#f59e0b','#22d3ee','#a78bfa'];
  var ovLbl = !!document.getElementById('ovLabels')?.checked;
  var ovObj = !!document.getElementById('ovObjects')?.checked;
  for(var ri=0;ri<routes.length;ri++){
          var rdata = routes[ri]; var path=rdata.points;
          if(!path || path.length<=1) continue;
          var color = (rdata.style && rdata.style.color) || palette[ri % palette.length];
          // Base road
          tctx.strokeStyle=hc?'#3a3a3a':'#2a2a2a'; tctx.lineWidth=18; tctx.lineCap='round'; tctx.beginPath();
          var p0 = scaleGameToPreview(path[0]); tctx.moveTo(p0.x, p0.y);
          for(var i=1;i<path.length;i++){ var p = scaleGameToPreview(path[i]); tctx.lineTo(p.x,p.y); }
          tctx.stroke();
          // Highlight center line
          tctx.strokeStyle=hc?'rgba(255,255,255,0.12)':'rgba(255,255,255,0.08)'; tctx.lineWidth=10; tctx.beginPath();
          p0 = scaleGameToPreview(path[0]); tctx.moveTo(p0.x, p0.y);
          for(var j=1;j<path.length;j++){ var q = scaleGameToPreview(path[j]); tctx.lineTo(q.x,q.y); }
          tctx.stroke();
          // Per-route color accent
          tctx.save(); tctx.globalAlpha=0.9; tctx.strokeStyle=color; tctx.lineWidth=3; tctx.beginPath();
          p0 = scaleGameToPreview(path[0]); tctx.moveTo(p0.x, p0.y);
          for(var k=1;k<path.length;k++){ var u = scaleGameToPreview(path[k]); tctx.lineTo(u.x,u.y); }
          tctx.stroke(); tctx.restore();
          // Markers
          var start=scaleGameToPreview(path[0]), goal=scaleGameToPreview(path[path.length-1]), rr=12;
          var label = (rdata.style && rdata.style.label) || (ri===0 ? 'S' : 'S'+(ri+1));
          // Start
          tctx.beginPath(); tctx.arc(start.x,start.y,rr,0,Math.PI*2); tctx.fillStyle=(ri===0 ? (hc?'#00c853':'#1e8e3e') : color); tctx.fill(); tctx.lineWidth=3; tctx.strokeStyle='#fff'; tctx.stroke();
          if(ovLbl){ tctx.fillStyle='#fff'; tctx.font='12px system-ui'; tctx.textAlign='center'; tctx.textBaseline='middle'; tctx.fillText(label, start.x, start.y+1); }
          // Goal
          tctx.lineWidth=3; tctx.strokeStyle='#fff'; tctx.beginPath(); tctx.arc(goal.x,goal.y,rr+4,0,Math.PI*2); tctx.stroke();
          tctx.strokeStyle=(hc?'#ffab00':'#c5221f'); tctx.beginPath(); tctx.arc(goal.x,goal.y,rr,0,Math.PI*2); tctx.stroke(); tctx.beginPath(); tctx.arc(goal.x,goal.y,Math.max(5,Math.floor(rr*0.5)),0,Math.PI*2); tctx.fillStyle=(hc?'#ffab00':'#c5221f'); tctx.fill();
        }
        // Environment preview (objects/bridges)
        if(ovObj && map && map.environment){
          try{
            const env = map.environment;
            // Bridges as blue bands
            const br = env.bridges||[];
            for(var bi=0; bi<br.length; bi++){
              var b=br[bi]; var p1=scaleGameToPreview({x:b.x,y:b.y}); var p2=scaleGameToPreview({x:b.x+b.w,y:b.y+b.h});
              var w=p2.x-p1.x, h=p2.y-p1.y; tctx.save(); tctx.fillStyle='rgba(120,180,240,0.18)'; tctx.strokeStyle='rgba(150,210,255,0.7)'; tctx.lineWidth=2; tctx.fillRect(p1.x,p1.y,w,h); tctx.strokeRect(p1.x,p1.y,w,h); tctx.restore();
            }
            // Other objects (rects or circles)
            const objs = env.objects||[]; for(var oi=0; oi<objs.length; oi++){
              var o=objs[oi]; if(o.type==='bridge') continue; if(o.w && o.h){ var q1=scaleGameToPreview({x:o.x,y:o.y}); var q2=scaleGameToPreview({x:o.x+o.w,y:o.y+o.h}); var ww=q2.x-q1.x, hh=q2.y-q1.y; tctx.save(); tctx.fillStyle=o.color||'rgba(60,200,255,0.12)'; tctx.strokeStyle='rgba(140,200,255,0.35)'; tctx.lineWidth=1; tctx.fillRect(q1.x,q1.y,ww,hh); tctx.strokeRect(q1.x,q1.y,ww,hh); tctx.restore(); }
              else { var c=scaleGameToPreview({x:o.x,y:o.y}); var c2=scaleGameToPreview({x:o.x+(o.r||10), y:o.y}); var rr2=Math.abs(c2.x-c.x)||6; tctx.save(); tctx.beginPath(); tctx.arc(c.x,c.y,rr2,0,Math.PI*2); tctx.fillStyle=o.color||'rgba(150,180,255,0.25)'; tctx.fill(); tctx.strokeStyle='rgba(0,0,0,0.35)'; tctx.lineWidth=1; tctx.stroke(); tctx.restore(); }
            }
          }catch(_e){}
  }
  tctx.restore();
        pctx.clearRect(0,0,prev.width,prev.height); pctx.drawImage(tmp,0,0);
        // Map info and legend
        var infoHost=document.getElementById('mapInfo');
        if(infoHost){ var desc=(map&&map.description)||''; var rt=routes.length; infoHost.innerHTML = '';
          if(desc){ var short = desc.length>140 ? desc.slice(0,140)+'…' : desc; infoHost.innerHTML += `<span id="mapDescShort">${short}</span>`; if(desc.length>140) infoHost.innerHTML += ` <a href="#" id="descMore">läs mer</a><span id="mapDescFull" style="display:none"> ${desc}</span>`; }
          infoHost.innerHTML += ` <span class="chip">${rt} rutt${rt>1?'er':''}</span>`; var more=document.getElementById('descMore'); if(more){ more.onclick=function(e){ e.preventDefault(); var full=document.getElementById('mapDescFull'); var shortEl=document.getElementById('mapDescShort'); if(full && shortEl){ if(full.style.display==='none'){ full.style.display='inline'; shortEl.style.display='none'; more.textContent='visa mindre'; } else { full.style.display='none'; shortEl.style.display='inline'; more.textContent='läs mer'; } } }; }
        }
        var leg=document.getElementById('previewLegend');
        if(leg){ var html=''; for(var li=0; li<routes.length; li++){ var rr=routes[li]; var color=(rr.style&&rr.style.color)||palette[li%palette.length]; var label=(rr.style&&rr.style.label)||('Rutt '+(li+1)); html += `<div class="item"><span class="swatch" style="background:${color}"></span><span>${label}</span></div>`; } leg.innerHTML = html; }
        // Tags and stats
        var tagHost=document.getElementById('mapTags'); if(tagHost){ var tags=[]; if(map){ var hasMulti=routes.length>1; var hasBridge = !!(map.environment && ((map.environment.bridges&&map.environment.bridges.length) || ((map.environment.objects||[]).some(function(o){return o.type==='bridge';})))); var hasMatrix = !!(map.environment && map.environment.matrix && map.environment.matrix.on); var isEndless = !!(map.settings && map.settings.endless); if(hasMulti) tags.push('Multi‑rutt'); if(hasBridge) tags.push('Broar'); if(hasMatrix) tags.push('Matrix'); if(isEndless) tags.push('Endless'); }
          tagHost.innerHTML = tags.map(function(t){ return `<span class="chip">${t}</span>`; }).join(' ');
        }
        var statsHost=document.getElementById('mapStats'); if(statsHost){ var L=0,B=0,D=0,cnt=0; for(var si=0;si<routes.length;si++){ var pts=routes[si].points||[]; if(pts.length<2) continue; cnt++; var res=(window.Maps&&window.Maps.analyzePath)? window.Maps.analyzePath(pts) : {difficulty:0,bends:0}; var len=0; for(var ii=0;ii<pts.length-1;ii++){ var a=pts[ii], b=pts[ii+1]; len += Math.hypot(b.x-a.x, b.y-a.y); } L+=len; B+= (res.bends||0); D+=(res.difficulty||0); }
          var dAvg = cnt? (D/cnt) : 0; statsHost.innerHTML = `<span class="chip">Längd ${(L|0)} px</span> <span class="chip">Böjar ${B}</span> <span class="chip">Svår ${dAvg.toFixed? dAvg.toFixed(1): dAvg}</span>`; }
      }
      drawPreview();
      mapPreset.addEventListener('change', function(){
        // Save selected map to localStorage for next reload
        var KEY = 'td-settings-v1';
        var data = {};
        try { data = JSON.parse(localStorage.getItem(KEY)||'{}')||{}; } catch(e){ data={}; }
        data.MapSettings = data.MapSettings || {};
        data.MapSettings.preset = mapPreset.value;
        localStorage.setItem(KEY, JSON.stringify(data));
        drawPreview();
        updateFavStar();
      });
  var btnRnd=document.getElementById('btnRandom');
  if(btnRnd){ btnRnd.addEventListener('click', function(ev){ try{ev.preventDefault();}catch(_e){} var opts=Array.prototype.slice.call(mapPreset.options||[]); if(opts.length){ var idx=Math.floor(Math.random()*opts.length); mapPreset.value=opts[idx].value; var evt=new Event('change'); mapPreset.dispatchEvent(evt); } }); }
  cbHC && cbHC.addEventListener('change', drawPreview);
  var ovL = document.getElementById('ovLabels'); var ovO=document.getElementById('ovObjects');
  ovL && ovL.addEventListener('change', drawPreview);
  ovO && ovO.addEventListener('change', drawPreview);
  window.addEventListener('resize', drawPreview);
  // Zoom/pan interactions on preview
  if(prev){
    let dragging=false, lastX=0, lastY=0;
    prev.addEventListener('wheel', function(e){
      e.preventDefault();
      const dpr = Math.max(1, Math.min(3, window.devicePixelRatio||1));
      const rect = prev.getBoundingClientRect();
      const cx = (e.clientX - rect.left) * dpr;
      const cy = (e.clientY - rect.top) * dpr;
      const prevScale = view.scale;
      const dir = (e.deltaY<0) ? 1.1 : 0.9;
      view.scale = Math.max(0.5, Math.min(3, view.scale * dir));
      const k = view.scale/prevScale;
      view.x = cx - k*(cx - view.x);
      view.y = cy - k*(cy - view.y);
      drawPreview();
    }, { passive: false });
    prev.addEventListener('mousedown', function(e){ dragging=true; lastX=e.clientX; lastY=e.clientY; prev.style.cursor='grabbing'; });
    window.addEventListener('mouseup', function(){ if(dragging){ dragging=false; prev.style.cursor='grab'; } });
    window.addEventListener('mousemove', function(e){ if(!dragging) return; const dx=e.clientX-lastX, dy=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; const dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1)); view.x += dx*dpr; view.y += dy*dpr; drawPreview(); });
    prev.addEventListener('dblclick', function(){ view.scale=1; view.x=0; view.y=0; drawPreview(); });
  }
  // Overlay toggles and filters wiring
  var ft = document.getElementById('filterText'); var ftype = document.getElementById('filterType'); var favBtn=document.getElementById('btnFav');
  if(ft) ft.addEventListener('input', function(){ populateMapDropdown(); drawPreview(); updateFavStar(); });
  if(ftype) ftype.addEventListener('change', function(){ populateMapDropdown(); drawPreview(); updateFavStar(); });
  if(favBtn){
    favBtn.addEventListener('click', function(e){ e.preventDefault(); var cur=mapPreset.value; if(!cur) return; toggleFav(cur); populateMapDropdown(); updateFavStar(); });
    updateFavStar();
  }
    };
  </script>
  <script>
    // Non-module fallback: draw a simple map preview inline (works over file://)
    (function(){
      // Fallback mapping for file:// users: map new presets to legacy ones if needed
      var PRESET_MAP = {
        twinLanes: 'zigzag',
        forkMerge: 'maze',
        overpass8: 'figure8',
        spiralCore: 'riverMeander',
        switchbacks: 'zigzag',
        islands: 'riverMeander',
        portals: 'figure8',
        pockets: 'maze'
      };
      function bind(){
        const c = document.getElementById('mapPrev'); if(!c) return; const ctx=c.getContext('2d');
        const sel = document.getElementById('mapPreset');
        const cbHC = document.getElementById('colorblind');
      const TILE=32; // fits the 480x300 preview well
      function buildPath(preset){
        // Fallback mapping for file:// users: map new presets to legacy ones if needed
        var PRESET_MAP = {
          twinLanes: 'zigzag',
          forkMerge: 'maze',
          overpass8: 'figure8',
          spiralCore: 'riverMeander',
          switchbacks: 'zigzag',
          islands: 'riverMeander',
          portals: 'figure8',
          pockets: 'maze'
        };
        if(PRESET_MAP[preset]) preset = PRESET_MAP[preset];
        const path=[]; const COLS=Math.max(3, Math.floor(c.width/TILE)); const ROWS=Math.max(3, Math.floor(c.height/TILE));
        const cx=(col)=>col*TILE+TILE/2, cy=(row)=>row*TILE+TILE/2;
  if(preset==='maze'){
          for(let i=1;i<COLS-1;i++) path.push({x:cx(i),y:cy(1)});
          for(let r=2;r<ROWS-2;r++) path.push({x:cx(COLS-2),y:cy(r)});
          for(let i=COLS-2;i>1;i--) path.push({x:cx(i),y:cy(ROWS-3)});
          for(let r=ROWS-4;r>1;r--) path.push({x:cx(2),y:cy(r)});
        } else if(preset==='figure8'){
          for(let i=1;i<COLS-1;i++) path.push({x:cx(i),y:cy(1)});
          for(let r=2;r<Math.floor(ROWS/2);r++) path.push({x:cx(COLS-2),y:cy(r)});
          for(let i=COLS-2;i>1;i--) path.push({x:cx(i),y:cy(Math.floor(ROWS/2))});
          for(let r=Math.floor(ROWS/2)+1;r<ROWS-2;r++) path.push({x:cx(2),y:cy(r)});
          for(let i=2;i<COLS-1;i++) path.push({x:cx(i),y:cy(ROWS-2)});
        } else if(preset==='zigzag'){
          let ltr=true;
          for(let r=1;r<ROWS-1;r++){
            if(ltr){ for(let c2=1;c2<COLS-1;c2++) path.push({x:cx(c2),y:cy(r)}); }
            else { for(let c2=COLS-2;c2>0;c2--) path.push({x:cx(c2),y:cy(r)}); }
            if(r<ROWS-2){ const last=path[path.length-1]; path.push({x:last.x, y:cy(r+1)}); }
            ltr=!ltr;
          }
        } else if(preset==='river' || preset==='spiral'){
          const samples=140; const midY=c.height/2; const amp=Math.max(TILE*2, c.height*0.32);
          for(let i=0;i<=samples;i++){
            const t=i/samples; const x=t*c.width; const y=midY + Math.sin(t*Math.PI*2.2)*amp*0.8 + Math.sin(t*Math.PI*5.4)*amp*0.2; path.push({x,y});
          }
        } else if(preset==='riverWide'){
          const samples=160, midY=c.height/2, amp=Math.max(TILE*2, c.height*0.42);
          for(let i=0;i<=samples;i++){ const t=i/samples; const x=t*c.width; const y=midY + Math.sin(t*Math.PI*1.9)*amp; path.push({x,y}); }
        } else if(preset==='riverTight'){
          const samples=180, midY=c.height/2, amp=Math.max(TILE*2, c.height*0.25);
          for(let i=0;i<=samples;i++){ const t=i/samples; const x=t*c.width; const y=midY + Math.sin(t*Math.PI*3.0)*amp*0.85 + Math.sin(t*Math.PI*6.0)*amp*0.18; path.push({x,y}); }
        } else if(preset==='riverMeander'){
          const samples=200, midY=c.height/2, amp=Math.max(TILE*2, c.height*0.36);
          for(let i=0;i<=samples;i++){ const t=i/samples; const x=t*c.width; const y=midY + Math.sin(t*Math.PI*1.6)*amp*0.9 + Math.sin(t*Math.PI*4.0)*amp*0.28; path.push({x,y}); }
        } else if(preset==='riverBraided'){
          const samples=200, midY=c.height/2, amp=Math.max(TILE*2, c.height*0.34);
          for(let i=0;i<=samples;i++){ const t=i/samples; const x=t*c.width; const y=midY + Math.sin(t*Math.PI*2.0)*amp*0.85 + Math.sin(t*Math.PI*3.2 + Math.PI/3)*amp*0.25; path.push({x,y}); }
        } else if(preset==='riverDelta'){
          const samples=200, midY=c.height/2, amp=Math.max(TILE*2, c.height*0.36);
          for(let i=0;i<=samples;i++){ const t=i/samples; const x=t*c.width; const y=midY + Math.sin(t*Math.PI*1.8)*amp*0.65 + Math.sin(t*Math.PI*4.2)*amp*0.18; path.push({x,y}); }
        } else if(preset==='random'){
          const pts=[]; const count=10;
          pts.push({x:TILE*0.75,y:c.height*0.25+Math.random()*c.height*0.5});
          for(let i=0;i<count;i++) pts.push({x:Math.random()*c.width, y:TILE*0.75+Math.random()*(c.height-TILE*1.5)});
          pts.push({x:c.width-TILE*0.75,y:c.height*0.25+Math.random()*c.height*0.5});
          pts.sort((a,b)=>a.x-b.x); pts.forEach(p=>path.push(p));
        } else if(preset==='clover'){
          // four lobes around center
          const midC=Math.floor(COLS/2), midR=Math.floor(ROWS/2);
          const r=3; const loop=(ox,oy)=>{
            for(let a=0;a<Math.PI*2;a+=Math.PI/6){ const x=midC+ox+Math.round(Math.cos(a)*r); const y=midR+oy+Math.round(Math.sin(a)*r); path.push({x:cx(x),y:cy(y)}); }
          };
          loop(-4,0); loop(4,0); loop(0,-3); loop(0,3);
        } else if(preset==='stadium'){
          // oval around edges with soft corners
          const L=1,R=COLS-2,T=1,B=ROWS-2;
          for(let c=L;c<=R;c++) path.push({x:cx(c),y:cy(T)});
          for(let r=T+1;r<=B;r++) path.push({x:cx(R),y:cy(r)});
          for(let c=R-1;c>=L;c--) path.push({x:cx(c),y:cy(B)});
          for(let r=B-1;r>=T;r--) path.push({x:cx(L),y:cy(r)});
        } else if(preset==='twinLanes'){
          const midR=Math.floor(ROWS/2); const top=Math.max(1, midR-3), bot=Math.min(ROWS-2, midR+3);
          for(let c2=1;c2<COLS-2;c2++) path.push({x:cx(c2),y:cy(top)});
          for(let r=top;r<=bot;r++) path.push({x:cx(COLS-2),y:cy(r)});
          for(let c2=COLS-2;c2>=3;c2--) path.push({x:cx(c2),y:cy(bot)});
          for(let c2=3;c2<COLS-1;c2++){
            const t=(c2-3)/Math.max(1,(COLS-1-3));
            const y=Math.round(bot + (midR-bot)*t);
            path.push({x:cx(c2), y:cy(Math.max(1, Math.min(ROWS-2,y))) });
          }
        } else if(preset==='forkMerge'){
          const midC=Math.floor(COLS/2), midR=Math.floor(ROWS/2);
          for(let c2=1;c2<=midC-1;c2++) path.push({x:cx(c2), y:cy(midR)});
          for(let r=midR-1;r>=2;r--) path.push({x:cx(midC-1), y:cy(r)});
          for(let c2=midC-1;c2<=midC+1;c2++) path.push({x:cx(c2), y:cy(2)});
          for(let r=2;r<=midR;r++) path.push({x:cx(midC+1), y:cy(r)});
          for(let r=midR+1;r<=ROWS-3;r++) path.push({x:cx(midC+1), y:cy(r)});
          for(let c2=midC+1;c2>=midC-1;c2--) path.push({x:cx(c2), y:cy(ROWS-3)});
          for(let r=ROWS-3;r>=midR;r--) path.push({x:cx(midC-1), y:cy(r)});
          for(let c2=midC-1;c2<COLS-1;c2++) path.push({x:cx(c2), y:cy(midR)});
        } else if(preset==='overpass8'){
          const midR=Math.floor(ROWS/2), midC=Math.floor(COLS/2), off=3;
          for(let c2=2;c2<COLS-2;c2++) path.push({x:cx(c2), y:cy(midR-off)});
          for(let r=midR-off;r<=midR-1;r++) path.push({x:cx(COLS-2), y:cy(r)});
          for(let c2=COLS-2;c2>=2;c2--) path.push({x:cx(c2), y:cy(midR-1)});
          for(let r=midR-1;r>=midR-off;r--) path.push({x:cx(2), y:cy(r)});
          for(let r=midR-off;r<=midR+off;r++) path.push({x:cx(midC), y:cy(r)});
          for(let c2=2;c2<COLS-2;c2++) path.push({x:cx(c2), y:cy(midR+off)});
          for(let r=midR+off;r<=midR+off+2;r++) path.push({x:cx(COLS-2), y:cy(r)});
          for(let c2=COLS-2;c2>=2;c2--) path.push({x:cx(c2), y:cy(midR+off+2)});
          for(let r=midR+off+2;r>=midR+off;r--) path.push({x:cx(2), y:cy(r)});
          for(let r=midR+off;r>=midR;r--) path.push({x:cx(midC+1), y:cy(r)});
          for(let c2=midC+1;c2<COLS-1;c2++) path.push({x:cx(c2), y:cy(midR)});
        } else if(preset==='spiralCore'){
          const cxp=c.width/2, cyp=c.height/2, maxR=Math.min(c.width,c.height)*0.42; const turns=2.3; const steps=140;
          for(let i=0;i<=steps;i++){ const t=i/steps; const ang=t*Math.PI*2*turns; const r=maxR*(1-t*0.85); const x=cxp+Math.cos(ang)*r; const y=cyp+Math.sin(ang)*r; path.push({x,y}); }
          const last=path[path.length-1]; for(let x=last.x; x<=c.width-24; x+=18){ path.push({x, y:last.y}); }
        } else if(preset==='switchbacks'){
          const stepR=2; let rr=2; let ltr=true;
          while(rr<=ROWS-3){ if(ltr){ for(let c2=1;c2<COLS-1;c2++) path.push({x:cx(c2), y:cy(rr)}); } else { for(let c2=COLS-2;c2>=1;c2--) path.push({x:cx(c2), y:cy(rr)}); } const r2=Math.min(ROWS-3, rr+stepR); for(let r=rr;r<=r2;r++) path.push({x:cx(ltr?COLS-2:1), y:cy(r)}); rr=r2+1; ltr=!ltr; }
        } else if(preset==='islands'){
          const samples=180, midY=c.height/2, amp=Math.max(TILE*2, c.height*0.34);
          for(let i=0;i<=samples;i++){ const t=i/samples; const x=t*c.width; const y=midY + Math.sin(t*Math.PI*1.9)*amp*0.85 + Math.sin(t*Math.PI*3.2)*amp*0.25; path.push({x,y}); }
        } else if(preset==='portals'){
          const midC=Math.floor(COLS/2), midR=Math.floor(ROWS/2);
          for(let c2=1;c2<=midC;c2++) path.push({x:cx(c2), y:cy(midR)});
          const rad=3; for(let a=0;a<=Math.PI*2;a+=Math.PI/10){ path.push({x: cx(midC)+Math.cos(a)*rad*TILE, y: cy(midR)+Math.sin(a)*rad*TILE }); }
          for(let c2=midC+1;c2<COLS-2;c2++){ const t=(c2-(midC+1))/(COLS-(midC+1)); const y=Math.round(midR + (2-midR)*t); path.push({x:cx(c2), y:cy(Math.max(1,Math.min(ROWS-2,y))) }); }
          for(let c2=COLS-2;c2<COLS-1;c2++) path.push({x:cx(c2), y:cy(3)});
        } else if(preset==='pockets'){
          const cxp=c.width/2, cyp=c.height/2; const rx=Math.max(80, c.width*0.38), ry=Math.max(60, c.height*0.28);
          const laps=3, steps=80; for(let lap=0; lap<laps; lap++){ const shrink=1-lap*0.18; for(let i=0;i<=steps;i++){ const t=i/steps*Math.PI*2; const x=cxp+Math.cos(t)*rx*shrink; const y=cyp+Math.sin(t)*ry*shrink; path.push({x,y}); } for(let k=0;k<4;k++) path.push({x: cxp + k*4, y: cyp + k*3 }); }
        } else {
          // ring
          for(let i=0;i<COLS;i++) path.push({x:cx(i),y:cy(1)});
          for(let r=2;r<ROWS-2;r++) path.push({x:cx(COLS-1),y:cy(r)});
          for(let i=COLS-1;i>=0;i--) path.push({x:cx(i),y:cy(ROWS-2)});
        }
        return path;
      }
    function draw(){
        const preset = (sel && sel.value) || 'ring';
        const path = buildPath(preset);
        ctx.clearRect(0,0,c.width,c.height);
        ctx.fillStyle='#0b0b0c'; ctx.fillRect(0,0,c.width,c.height);
        if(path.length>1){
      const hc = !!cbHC?.checked;
      ctx.strokeStyle=hc?'#3a3a3a':'#2a2a2a'; ctx.lineWidth=18; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y); for(const p of path){ ctx.lineTo(p.x,p.y); } ctx.stroke();
      ctx.strokeStyle=hc?'rgba(255,255,255,0.12)':'rgba(255,255,255,0.08)'; ctx.lineWidth=10; ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y); for(const p of path){ ctx.lineTo(p.x,p.y); } ctx.stroke();
          // Start/Goal markers
          const start=path[0], goal=path[path.length-1]; const r=12;
      ctx.beginPath(); ctx.arc(start.x,start.y,r,0,Math.PI*2); ctx.fillStyle=(hc?'#00c853':'#1e8e3e'); ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.stroke();
          ctx.fillStyle='#fff'; ctx.font='12px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('S', start.x, start.y+1);
          ctx.lineWidth=3; ctx.strokeStyle='#fff'; ctx.beginPath(); ctx.arc(goal.x,goal.y,r+4,0,Math.PI*2); ctx.stroke();
      ctx.strokeStyle=(hc?'#ffab00':'#c5221f'); ctx.beginPath(); ctx.arc(goal.x,goal.y,r,0,Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(goal.x,goal.y,Math.max(5,Math.floor(r*0.5)),0,Math.PI*2); ctx.fillStyle=(hc?'#ffab00':'#c5221f'); ctx.fill();
        }
      }
      // If the module didn't draw anything, render fallback preview
      function maybeDraw(){ try{ const a=ctx.getImageData(0,0,1,1).data[3]; if(a===0) draw(); }catch(e){ draw(); } }
      setTimeout(maybeDraw, 300);
  sel && sel.addEventListener('change', draw);
  cbHC && cbHC.addEventListener('change', draw);
      window.addEventListener('resize', draw);
      }
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind); else bind();
    })();
  </script>
  <script>
    // Fallback: bind Start after DOM is ready (works over file:// even without modules)
    (function(){
      const qs = s=>document.querySelector(s);
  function bind(){
        const btn = qs('#btnStart');
        if(!btn) return;
        btn.addEventListener('click', (ev)=>{
          try{ ev.preventDefault(); }catch(_e){}
          try{
            const mapPreset = qs('#mapPreset')?.value || 'ring';
            const PRESET_MAP = {
              twinLanes: 'zigzag',
              forkMerge: 'maze',
              overpass8: 'figure8',
              spiralCore: 'riverMeander',
              switchbacks: 'zigzag',
              islands: 'riverMeander',
              portals: 'figure8',
              pockets: 'maze'
            };
            const mapped = PRESET_MAP[mapPreset] || mapPreset;
            const diff = Math.max(1, Math.min(5, parseInt(qs('#difficulty')?.value)||1));
            const endless = !!qs('#endless')?.checked;
            const buildMode = qs('#buildMode')?.value || 'paint';
            const colorblind = !!qs('#colorblind')?.checked;
            const reducedMotion = !!qs('#reducedMotion')?.checked;
            const KEY='td-settings-v1';
            let data={};
            try{ data = JSON.parse(localStorage.getItem(KEY)||'{}')||{}; }catch(err){ data={}; }
            data.Settings = { ...(data.Settings||{}), buildMode, maxSpeed: (data.Settings && data.Settings.maxSpeed) || 5 };
            data.MapSettings = { ...(data.MapSettings||{}), preset: mapped, difficulty: diff, endless };
            data.Visuals = { ...(data.Visuals||{}), colorblindMode: colorblind, reducedMotion, theme: (data.Visuals && data.Visuals.theme) || 'dim' };
            data.ts = Date.now();
            localStorage.setItem(KEY, JSON.stringify(data));
          }catch(err){ /* ignore and still navigate */ }
          location.href = './SPEL.HTML';
        });
  const rnd = qs('#btnRandom');
  if(rnd){ rnd.addEventListener('click', (ev)=>{ ev.preventDefault(); const sel=qs('#mapPreset'); if(!sel) return; const opts=[...sel.options]; if(!opts.length) return; const idx=Math.floor(Math.random()*opts.length); sel.value=opts[idx].value; sel.dispatchEvent(new Event('change')); }); }
      }
      if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bind); else bind();
    })();
  </script>
  
  <script>
    // Quick accent palette chips (optional)
    (function(){
      function bind(){
        var host = document.getElementById('paletteChips'); if(!host) return;
        var colors = ['#2d6','#3b82f6','#e91e63','#f59e0b','#10b981','#00e5ff'];
        host.innerHTML = '';
        colors.forEach(function(col){
          var b=document.createElement('button'); b.type='button'; b.textContent=' '; b.style.width='28px'; b.style.height='28px'; b.style.borderRadius='6px'; b.style.border='1px solid #333'; b.style.background=col; b.style.cursor='pointer'; b.title=col; b.style.marginRight='6px';
          b.onclick=function(){ try{ var KEY='td-settings-v1'; var data={}; try{ data=JSON.parse(localStorage.getItem(KEY)||'{}')||{}; }catch(_e){ data={}; } data.Visuals = { ...(data.Visuals||{}), _accent: col, theme: 'custom' }; data.ts=Date.now(); localStorage.setItem(KEY, JSON.stringify(data)); alert('Accent uppdaterad. Starta spelet för att se ändringen.'); }catch(_e){} };
          host.appendChild(b);
        });
      }
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', bind); else bind();
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="hdr"><div class="title">Kaffekatten TD</div><div class="small">Alpha</div></div>
    <div class="hero">
      <div class="heroLogo" aria-hidden="true">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="10" width="22" height="18" rx="4" fill="#18202a" stroke="#3a3f47"/>
          <rect x="26" y="13" width="8" height="12" rx="6" fill="#14181f" stroke="#3a3f47"/>
          <path d="M10 26c3 3 11 3 14 0" stroke="#22c55e" stroke-width="2" stroke-linecap="round"/>
          <path d="M13 8c-1 2 2 3 1 5M18 7c-1 2 2 3 1 5M23 8c-1 2 2 3 1 5" stroke="#b3e5c5" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="heroText">
        <h1>Bygg, försvara, uppgradera</h1>
        <p>Ett snabbt tower defense med tydliga banor och smarta torn. Välj karta, justera inställningar och kör igång på sekunder.</p>
      </div>
    </div>
    <div class="grid">
      <div class="card">
        <label>Karta</label>
        <div class="filters">
          <input id="filterText" placeholder="Sök karta..." />
          <select id="filterType">
            <option value="alla">Alla</option>
            <option value="standard">Standard</option>
            <option value="egen">Egen</option>
            <option value="favorit">Favorit</option>
          </select>
          <a id="btnFav" href="#" class="starBtn" title="Markera som favorit">☆ Favorit</a>
        </div>
        <select id="mapPreset"><!-- Options populated by JS --></select>
        <div class="row">
          <div>
            <label>Svårighet (1–5)</label>
            <input id="difficulty" type="number" min="1" max="5" value="1" />
          </div>
          <div>
            <label>&nbsp;</label>
            <label style="display:flex;gap:8px;align-items:center"><input id="endless" type="checkbox" /> Endless</label>
          </div>
        </div>
        <label>Bygg‑läge</label>
        <select id="buildMode">
          <option value="paint">Paint</option>
          <option value="single">Single</option>
        </select>
        <div class="row" style="margin-top:8px">
          <label style="display:flex;gap:8px;align-items:center"><input id="colorblind" type="checkbox" /> Högkontrast (färgblind)</label>
          <label style="display:flex;gap:8px;align-items:center"><input id="reducedMotion" type="checkbox" /> Minska rörelse</label>
        </div>
    <div class="small" style="margin-top:8px">Snabbt val: accent</div>
    <div id="paletteChips" class="row-btns" style="margin-top:4px"></div>
  <div class="row-btns">
    <a id="btnStart" class="btn btn-primary" href="./SPEL.HTML">Starta spelet</a>
    <a id="btnRandom" class="btn-ghost" href="#">Slumpa karta</a>
  </div>
        <div class="links"><a href="./ADMIN.html">Admin</a></div>
        
        <div class="small" style="margin-top:8px">Tips: När spelet startat kan du hålla musen över knapparna för att se deras snabbkommandon.</div>
      </div>
      <div class="card preview">
        <div class="row" style="grid-template-columns:auto auto 1fr; align-items:center; gap:10px; margin-bottom:6px">
          <div class="small">Förhandsvisning</div>
          <label class="small" style="display:flex;gap:6px;align-items:center"><input id="ovLabels" type="checkbox" checked /> Visa etiketter</label>
          <label class="small" style="display:flex;gap:6px;align-items:center;justify-content:flex-end"><input id="ovObjects" type="checkbox" /> Visa objekt</label>
        </div>
        <canvas id="mapPrev" width="480" height="300" style="width:100%;height:auto;aspect-ratio:8/5;border-radius:10px;display:block;cursor:grab"></canvas>
        <div id="mapInfo" class="small" style="margin-top:8px"></div>
        <div id="mapTags" class="chips" style="margin-top:6px"></div>
        <div id="mapStats" class="chips" style="margin-top:6px"></div>
        <div id="previewLegend" class="legend"></div>
      </div>
    </div>
  </div>
</body>
</html>
