<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Kaffekatten TD</title>
  <style>
    html,body{height:100%;margin:0;background:#0f0f10;color:#eee;font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:24px auto;padding:0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .panel{background:#151515;padding:14px;border-radius:10px}
    input,select,button{padding:8px;border-radius:6px;border:1px solid #333;background:#0b0b0b;color:#fff}
    input,select{width:100%;margin:6px 0}
    button{cursor:pointer;background:#2d6;border:0}
    h2,h3{margin:6px 0 10px 0}
    .row{display:flex;gap:8px;align-items:center}
    .footer{margin-top:18px;display:flex;gap:8px}
    a{color:#8cf}
  </style>
  <script type="module">
  import { Admin, Settings, Visuals, MapSettings, Audio } from './src/constants.js';
    import { TOWER_TYPES } from './src/towers.js';
    import { saveSettingsDump, loadSettingsApply, saveSettingsAsXML, importSettingsXMLFromText } from './src/persist.js';
    loadSettingsApply();
    const qs = s=>document.querySelector(s);
    const adminStartMoney = qs('#adminStartMoney');
    const adminStartLives = qs('#adminStartLives');
    const adminMaxSpeed = qs('#adminMaxSpeed');
  const uiShowGrid = qs('#uiShowGrid');
  const uiPathWidth = qs('#uiPathWidth');
  const mapPreset = qs('#mapPreset');
  const mapDifficulty = qs('#mapDifficulty');
  const endless = qs('#endless');
  const buildMode = qs('#buildMode');
  const mute = qs('#mute');
    const towersList = qs('#towersList');
    const form = {
      name: qs('#newName'), cost: qs('#newCost'), range: qs('#newRange'), dmg: qs('#newDmg'), rate: qs('#newRate'), color: qs('#newColor')
    };
    // Init values
    adminStartMoney.value = Admin.startMoney;
    adminStartLives.value = Admin.startLives;
    adminMaxSpeed.value = Settings.maxSpeed;
  uiShowGrid.value = Visuals.showGrid? '1':'0';
  uiPathWidth.value = Visuals.pathWidth;
  mapPreset.value = MapSettings.preset;
  mapDifficulty.value = String(MapSettings.difficulty);
  endless.checked = !!MapSettings.endless;
  buildMode.value = Settings.buildMode;
  mute.checked = !!Audio.muted;
    function refreshList(){
      towersList.innerHTML = '';
      Object.values(TOWER_TYPES).forEach(def=>{
        const li = document.createElement('div'); li.className='row'; li.style.justifyContent='space-between'; li.style.alignItems='center';
        const left = document.createElement('div'); left.className='row';
        left.innerHTML = `<strong style="width:120px">${def.label}</strong><span>pris ${def.cost}</span><span>R ${def.range}</span><span>D ${def.dmg}</span><span>Rt ${def.fireRate}s</span>`;
        const right = document.createElement('div');
        if(!def.builtIn){
          const del=document.createElement('button'); del.textContent='Ta bort'; del.style.background='#b33'; del.style.marginLeft='8px';
          del.addEventListener('click',()=>{
            if(!confirm(`Ta bort tornet "${def.label}"?`)) return;
            delete TOWER_TYPES[def.id];
            saveSettingsDump();
            try{ loadSettingsApply(); }catch(e){}
            refreshList();
            savedAt.textContent='Torn borttaget ' + new Date().toLocaleTimeString();
          });
          right.appendChild(del);
        }
        li.appendChild(left); li.appendChild(right);
        towersList.appendChild(li);
      });
    }
    refreshList();
    // Save settings (with immediate verification and UI feedback)
    const savedAt = document.createElement('div');
    savedAt.className='small';
    qs('.panel').appendChild(savedAt);
  qs('#btnSave').addEventListener('click',()=>{
      Admin.startMoney = parseInt(adminStartMoney.value)||Admin.startMoney;
      Admin.startLives = parseInt(adminStartLives.value)||Admin.startLives;
      Settings.maxSpeed = Math.max(1, parseFloat(adminMaxSpeed.value)||Settings.maxSpeed);
  Visuals.showGrid = uiShowGrid.value==='1';
  Visuals.pathWidth = Math.max(8, Math.min(64, parseInt(uiPathWidth.value)||Visuals.pathWidth));
  MapSettings.preset = mapPreset.value;
  MapSettings.difficulty = Math.max(1, Math.min(5, parseInt(mapDifficulty.value)||MapSettings.difficulty));
  MapSettings.endless = !!endless.checked;
  Settings.buildMode = buildMode.value;
  Audio.muted = !!mute.checked;
      saveSettingsDump();
      try{
        // Verify round-trip read
        loadSettingsApply();
        savedAt.textContent = 'Sparat ' + new Date().toLocaleTimeString();
      }catch(e){ savedAt.textContent='Sparfel – testa igen'; }
    });
  // Add tower
    qs('#btnAddTower').addEventListener('click',()=>{
      let id = (form.name.value||'').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
      if(!id) return alert('Ogiltigt namn');
      if(TOWER_TYPES[id]) return alert('Id finns redan');
      const def = {
        id,
        label: form.name.value||id,
        cost: Math.max(1, parseInt(form.cost.value)||50),
        range: Math.max(20, parseInt(form.range.value)||80),
        dmg: Math.max(1, parseInt(form.dmg.value)||5),
        fireRate: Math.max(0.05, parseFloat(form.rate.value)||1),
        color: /^#([0-9a-f]{3}){1,2}$/i.test(form.color.value) ? form.color.value : '#ccc',
        sellFactor: 0.7
      };
  TOWER_TYPES[id] = def;
  refreshList();
  saveSettingsDump();
  try{ loadSettingsApply(); savedAt.textContent='Torn sparat ' + new Date().toLocaleTimeString(); }catch(e){ savedAt.textContent='Torn sparfel'; }
    });
    // XML export/import
    const btnExport = document.getElementById('btnExportXML');
    const btnImport = document.getElementById('btnImportXML');
    const fileInput = document.getElementById('xmlFile');
    btnExport.addEventListener('click',()=>{ saveSettingsAsXML(); });
    btnImport.addEventListener('click',()=>{ fileInput.click(); });
    fileInput.addEventListener('change',async ()=>{
      const f = fileInput.files && fileInput.files[0]; if(!f) return;
      const text = await f.text();
      const ok = await importSettingsXMLFromText(text);
      if(ok){ loadSettingsApply(); refreshList(); savedAt.textContent='XML importerat ' + new Date().toLocaleTimeString(); }
      else { alert('Kunde inte importera XML.'); }
    });
    // mark module as loaded so fallback won’t double-bind
    window.__adminModuleLoaded = true;
  </script>
  <script>
    // Fallback for file:// when ES modules are blocked: wire Admin using localStorage and inline XML
    (function(){
      function run(){ if(window.__adminModuleLoaded) return; // module worked; skip fallback
      var qs = function(s){ return document.querySelector(s); };
      var KEY='td-settings-v1';
      function loadLocal(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}')||{}; }catch(e){ return {}; } }
      function saveLocal(obj){ try{ obj.ts=Date.now(); localStorage.setItem(KEY, JSON.stringify(obj)); return true; }catch(e){ return false; } }
      function ensureShape(d){
        d.Admin = d.Admin || { startMoney:100, startLives:10, upgCost:{dmg:30,range:25,rate:35} };
        d.Settings = d.Settings || { maxSpeed:5, buildMode:'paint' };
        d.Visuals = d.Visuals || { showGrid:true, pathWidth:24 };
        d.MapSettings = d.MapSettings || { preset:'ring', difficulty:1, endless:false };
        d.Audio = d.Audio || { muted:true };
        d.TOWER_TYPES = d.TOWER_TYPES || {};
        return d;
      }
      function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }
      function toXML(d){
        d=ensureShape(d);
        var t = Object.keys(d.TOWER_TYPES).map(function(id){ var def=d.TOWER_TYPES[id]; return '    <Tower id="'+esc(def.id||id)+'" label="'+esc(def.label||id)+'" cost="'+(def.cost||50)+'" range="'+(def.range||80)+'" dmg="'+(def.dmg||5)+'" fireRate="'+(def.fireRate||1)+'" color="'+esc(def.color||'#ccc')+'" sellFactor="'+(def.sellFactor==null?0.7:def.sellFactor)+'"'+(def.aoe?' aoe="'+def.aoe+'"':'')+(def.slow?' slow="'+def.slow+'"':'')+(def.slowTime?' slowTime="'+def.slowTime+'"':'')+' />'; }).join('\n');
        return '<?xml version="1.0" encoding="UTF-8"?>\n<kaffekatten>\n  <Admin startMoney="'+d.Admin.startMoney+'" startLives="'+d.Admin.startLives+'">\n    <upgCost dmg="'+d.Admin.upgCost.dmg+'" range="'+d.Admin.upgCost.range+'" rate="'+d.Admin.upgCost.rate+'" />\n  </Admin>\n  <Settings maxSpeed="'+d.Settings.maxSpeed+'" buildMode="'+esc(d.Settings.buildMode)+'" />\n  <Visuals showGrid="'+!!d.Visuals.showGrid+'" pathWidth="'+d.Visuals.pathWidth+'" />\n  <Map preset="'+esc(d.MapSettings.preset)+'" difficulty="'+d.MapSettings.difficulty+'" endless="'+!!d.MapSettings.endless+'" />\n  <Audio muted="'+!!d.Audio.muted+'" />\n  <Towers>\n'+t+'\n  </Towers>\n  <timestamp>'+Date.now()+'</timestamp>\n</kaffekatten>';
      }
      function applyXMLToObj(text, d){
        var parser = new DOMParser(); var doc = parser.parseFromString(text,'application/xml');
        if(doc.querySelector('parsererror')) return false;
        function get(sel){ return doc.querySelector(sel); }
        d=ensureShape(d);
        var adminEl = get('kaffekatten > Admin'); if(adminEl){ var sm=parseInt(adminEl.getAttribute('startMoney')); var sl=parseInt(adminEl.getAttribute('startLives')); if(!isNaN(sm)) d.Admin.startMoney=sm; if(!isNaN(sl)) d.Admin.startLives=sl; var upg=get('kaffekatten > Admin > upgCost'); if(upg){ var dd=parseInt(upg.getAttribute('dmg')); var rr=parseInt(upg.getAttribute('range')); var rt=parseInt(upg.getAttribute('rate')); if(!isNaN(dd)) d.Admin.upgCost.dmg=dd; if(!isNaN(rr)) d.Admin.upgCost.range=rr; if(!isNaN(rt)) d.Admin.upgCost.rate=rt; } }
        var setEl = get('kaffekatten > Settings'); if(setEl){ var ms=parseFloat(setEl.getAttribute('maxSpeed')); var bm=setEl.getAttribute('buildMode'); if(!isNaN(ms)) d.Settings.maxSpeed=ms; if(bm) d.Settings.buildMode=bm; }
        var visEl = get('kaffekatten > Visuals'); if(visEl){ d.Visuals.showGrid = visEl.getAttribute('showGrid')==='true'; var pw=parseInt(visEl.getAttribute('pathWidth')); if(!isNaN(pw)) d.Visuals.pathWidth=pw; }
        var mapEl = get('kaffekatten > Map'); if(mapEl){ var pr=mapEl.getAttribute('preset'); var df=parseInt(mapEl.getAttribute('difficulty')); var en=mapEl.getAttribute('endless')==='true'; if(pr) d.MapSettings.preset=pr; if(!isNaN(df)) d.MapSettings.difficulty=df; d.MapSettings.endless=en; }
        var audEl = get('kaffekatten > Audio'); if(audEl){ d.Audio.muted = audEl.getAttribute('muted')==='true'; }
        var towers = doc.querySelectorAll('kaffekatten > Towers > Tower'); towers.forEach(function(el){ var id = el.getAttribute('id'); if(!id) return; var def = d.TOWER_TYPES[id] || { id:id }; def.id=id; def.label=el.getAttribute('label')||id; function ni(name){ var v=parseFloat(el.getAttribute(name)); return isNaN(v)?undefined:v; } function str(name){ return el.getAttribute(name); } var merged={
          id: def.id,
          label: def.label,
          cost: ni('cost') ?? def.cost ?? 50,
          range: ni('range') ?? def.range ?? 80,
          dmg: ni('dmg') ?? def.dmg ?? 5,
          fireRate: ni('fireRate') ?? def.fireRate ?? 1,
          color: str('color') || def.color || '#ccc',
          sellFactor: ni('sellFactor') ?? def.sellFactor ?? 0.7,
          aoe: ni('aoe') ?? def.aoe,
          slow: ni('slow') ?? def.slow,
          slowTime: ni('slowTime') ?? def.slowTime,
        }; d.TOWER_TYPES[id]=merged; });
        return d;
      }

      // UI wire
      var adminStartMoney = qs('#adminStartMoney');
      var adminStartLives = qs('#adminStartLives');
      var adminMaxSpeed = qs('#adminMaxSpeed');
      var uiShowGrid = qs('#uiShowGrid');
      var uiPathWidth = qs('#uiPathWidth');
      var mapPreset = qs('#mapPreset');
      var mapDifficulty = qs('#mapDifficulty');
      var endless = qs('#endless');
      var buildMode = qs('#buildMode');
      var mute = qs('#mute');
  var towersList = qs('#towersList');
      var savedAt = document.createElement('div'); savedAt.style.marginTop='8px'; savedAt.style.fontSize='12px'; savedAt.style.color='#aaa';
      var firstPanel = document.querySelector('.panel'); if(firstPanel) firstPanel.appendChild(savedAt);

      var data = ensureShape(loadLocal());
      function refreshList(){
        towersList.innerHTML='';
        Object.keys(data.TOWER_TYPES).forEach(function(k){
          var def=data.TOWER_TYPES[k];
          var li=document.createElement('div'); li.className='row'; li.style.justifyContent='space-between';
          var left=document.createElement('div'); left.className='row';
          left.innerHTML='<strong style="width:120px">'+(def.label||def.id)+'</strong><span>pris '+(def.cost||'')+'</span><span>R '+(def.range||'')+'</span><span>D '+(def.dmg||'')+'</span><span>Rt '+(def.fireRate||'')+'s</span>';
          var right=document.createElement('div');
          if(!def.builtIn){
            var del=document.createElement('button'); del.textContent='Ta bort'; del.style.background='#b33'; del.style.marginLeft='8px';
            del.addEventListener('click', function(){ if(!confirm('Ta bort tornet \''+(def.label||def.id)+'\'?')) return; delete data.TOWER_TYPES[def.id]; saveLocal(data); refreshList(); savedAt.textContent='Torn borttaget ' + new Date().toLocaleTimeString(); });
            right.appendChild(del);
          }
          li.appendChild(left); li.appendChild(right);
          towersList.appendChild(li);
        });
      }
      function fill(){ adminStartMoney.value=data.Admin.startMoney; adminStartLives.value=data.Admin.startLives; adminMaxSpeed.value=data.Settings.maxSpeed; uiShowGrid.value=data.Visuals.showGrid?'1':'0'; uiPathWidth.value=data.Visuals.pathWidth; mapPreset.value=data.MapSettings.preset; mapDifficulty.value=String(data.MapSettings.difficulty); endless.checked=!!data.MapSettings.endless; buildMode.value=data.Settings.buildMode; mute.checked=!!data.Audio.muted; refreshList(); }
      fill();

      // Save button
      var btnSave = qs('#btnSave');
      btnSave && btnSave.addEventListener('click', function(){
        data.Admin.startMoney = parseInt(adminStartMoney.value)||data.Admin.startMoney;
        data.Admin.startLives = parseInt(adminStartLives.value)||data.Admin.startLives;
        data.Settings.maxSpeed = Math.max(1, parseFloat(adminMaxSpeed.value)||data.Settings.maxSpeed);
        data.Visuals.showGrid = uiShowGrid.value==='1';
        data.Visuals.pathWidth = Math.max(8, Math.min(64, parseInt(uiPathWidth.value)||data.Visuals.pathWidth));
        data.MapSettings.preset = mapPreset.value;
        data.MapSettings.difficulty = Math.max(1, Math.min(5, parseInt(mapDifficulty.value)||data.MapSettings.difficulty));
        data.MapSettings.endless = !!endless.checked;
        data.Settings.buildMode = buildMode.value;
        data.Audio.muted = !!mute.checked;
        saveLocal(data);
        savedAt.textContent='Sparat ' + new Date().toLocaleTimeString();
      });

      // Add tower
      var form = { name: qs('#newName'), cost: qs('#newCost'), range: qs('#newRange'), dmg: qs('#newDmg'), rate: qs('#newRate'), color: qs('#newColor') };
      var btnAddTower = qs('#btnAddTower');
      btnAddTower && btnAddTower.addEventListener('click', function(){
        var id = (form.name.value||'').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); if(!id){ alert('Ogiltigt namn'); return; }
        if(data.TOWER_TYPES[id]){ alert('Id finns redan'); return; }
        var def={ id:id, label: form.name.value||id, cost: Math.max(1, parseInt(form.cost.value)||50), range: Math.max(20, parseInt(form.range.value)||80), dmg: Math.max(1, parseInt(form.dmg.value)||5), fireRate: Math.max(0.05, parseFloat(form.rate.value)||1), color: /^#([0-9a-f]{3}){1,2}$/i.test(form.color.value) ? form.color.value : '#ccc', sellFactor: 0.7 };
        data.TOWER_TYPES[id]=def; saveLocal(data); refreshList(); savedAt.textContent='Torn sparat ' + new Date().toLocaleTimeString();
      });

      // Export XML
      var btnExport = document.getElementById('btnExportXML');
      btnExport && btnExport.addEventListener('click', function(){
        try{ var xml=toXML(data); var blob=new Blob([xml],{type:'application/xml'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kaffekatten-settings.xml'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); },0); }catch(e){ alert('Kunde inte exportera XML.'); }
      });

      // Import XML
      var btnImport = document.getElementById('btnImportXML'); var fileInput=document.getElementById('xmlFile');
      btnImport && btnImport.addEventListener('click', function(){ fileInput && fileInput.click(); });
      fileInput && fileInput.addEventListener('change', function(){ var f=fileInput.files && fileInput.files[0]; if(!f) return; var reader=new FileReader(); reader.onload=function(){ var txt=String(reader.result||''); var ok = applyXMLToObj(txt, data); if(ok){ saveLocal(data); fill(); savedAt.textContent='XML importerat ' + new Date().toLocaleTimeString(); } else { alert('Ogiltig XML.'); } }; reader.readAsText(f); });
      }
      if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', run); else run();
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <h2>Admin • Kaffekatten TD</h2>
    <div class="grid">
      <div class="panel">
        <h3>Spelinställningar</h3>
        <label>Startpengar</label>
        <input id="adminStartMoney" type="number" value="100" />
        <label>Startliv</label>
        <input id="adminStartLives" type="number" value="10" />
        <label>Max hastighet (1-5)</label>
        <input id="adminMaxSpeed" type="number" value="5" />
        <label>Visa rutnät</label>
        <select id="uiShowGrid"><option value="1">Ja</option><option value="0">Nej</option></select>
        <label>Vägbredd</label>
        <input id="uiPathWidth" type="number" value="24" min="8" max="64" />
          <label>Karta</label>
          <select id="mapPreset">
            <option value="ring">Outer Ring</option>
            <option value="maze">Maze</option>
            <option value="figure8">Figure Eight</option>
          </select>
          <label>Svårighet (1-5)</label>
          <input id="mapDifficulty" type="number" value="1" min="1" max="5" />
          <label><input id="endless" type="checkbox" /> Endless</label>
          <label>Bygg-läge</label>
          <select id="buildMode">
            <option value="paint">Paint</option>
            <option value="single">Single</option>
          </select>
          <label><input id="mute" type="checkbox" /> Mute</label>
        <div class="footer">
          <button id="btnSave">Spara inställningar</button>
          <a href="./SPEL.HTML">Tillbaka till spelet</a>
        </div>
        <div class="footer">
          <button id="btnExportXML">Exportera som XML</button>
          <button id="btnImportXML">Importera XML</button>
          <input id="xmlFile" type="file" accept=".xml,application/xml" style="display:none" />
        </div>
      </div>
      <div class="panel">
        <h3>Torn</h3>
        <div id="towersList" style="display:flex;flex-direction:column;gap:6px"></div>
        <hr>
        <div class="row"><input id="newName" placeholder="namn" /></div>
        <div class="row"><input id="newCost" type="number" placeholder="pris" value="80" /><input id="newRange" type="number" placeholder="räckvidd" value="90" /></div>
        <div class="row"><input id="newDmg" type="number" placeholder="skada" value="8" /><input id="newRate" type="number" placeholder="eldhast (s)" value="1" /></div>
        <div class="row"><input id="newColor" placeholder="#rrggbb" value="#ffb86b" /></div>
        <button id="btnAddTower">Lägg till torn</button>
      </div>
    </div>
  </div>
</body>
</html>
