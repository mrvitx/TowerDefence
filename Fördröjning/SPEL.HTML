<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kaffekatten Tower Defense — Full version</title>
  <style>
    :root{
      --bg:#0f0f10; --panel:#151515; --edge:#2a2a2a; --txt:#eee; --muted:#aaa; --accent:#2d6; --panel2:#101010; --btn2:#3a3a3a; --radius:10px; --ui-scale:1;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,Segoe UI,Roboto,Arial}
    html{font-size:calc(16px * var(--ui-scale));}
    #app{display:grid;grid-template-rows:auto 1fr;grid-template-columns:240px 1fr;grid-template-areas:"sidebar toolbar" "sidebar main";gap:10px;padding:10px;transform:scale(var(--ui-scale));transform-origin:top left}
  .toolbar{grid-area:toolbar;background:var(--panel);border-radius:var(--radius);padding:10px;display:flex;align-items:center;gap:10px;border:1px solid var(--edge);box-shadow:0 2px 10px rgba(0,0,0,0.25)}
  .sidebar{grid-area:sidebar;background:var(--panel);border-radius:var(--radius);padding:10px;display:flex;flex-direction:column;gap:10px;min-height:0;border:1px solid var(--edge);box-shadow:0 2px 12px rgba(0,0,0,0.25)}
  /* Top-align the game area to avoid a large gap under the toolbar */
  .main{grid-area:main;display:flex;align-items:flex-start;justify-content:center;position:relative}
  canvas{background:#0b0b0b;border:6px solid #222;image-rendering:pixelated;max-width:100%;height:auto;border-radius:calc(var(--radius) - 4px);box-shadow:0 10px 24px rgba(0,0,0,0.35)}
  .stat{display:flex;gap:12px}
  .stat > div{background:var(--panel2);padding:6px 10px;border-radius:8px;border:1px solid #232323;box-shadow:inset 0 1px 0 rgba(255,255,255,0.03)}
  .tower-list{display:grid;grid-template-columns:1fr;gap:10px;overflow:auto}
  .panel{background:var(--panel2);padding:8px;border-radius:8px;border:1px solid #232323;box-shadow:0 1px 6px rgba(0,0,0,0.25)}
  button{padding:8px 10px;border-radius:6px;border:0;background:var(--accent);cursor:pointer;color:#fff;transition:transform .06s ease, filter .12s ease}
  button:hover{filter:brightness(1.06)}
  button:active{transform:translateY(1px)}
  .btn-secondary{background:var(--btn2);color:#fff}
    .small{font-size:12px;color:var(--muted)}
    .hidden{display:none}
    /* Profile chip */
    .profile-chip{display:inline-flex;flex-direction:column;align-items:flex-start;gap:4px;min-width:180px}
  .profile-chip .pc-line{display:flex;gap:8px;align-items:baseline}
  .profile-chip #pcName{font-weight:700}
  .profile-chip #pcLvl{font-size:12px;opacity:.9}
    .xpbar{display:block;width:100%;height:8px;background:rgba(0,0,0,.35);border-radius:999px;overflow:hidden;border:1px solid rgba(17,242,122,.25)}
    .xpbar .xpbar-fill{display:block;height:100%;width:0;background:
      repeating-linear-gradient(135deg, rgba(17,242,122,.85) 0 8px, rgba(17,242,122,.55) 8px 16px);
      box-shadow:0 0 12px rgba(17,242,122,.45), inset 0 0 6px rgba(0,0,0,.35);
      transition:width .25s ease}
    .pc-xp-row{display:flex;gap:8px;align-items:center;width:100%}
    .pc-xp-row #pcXpPct{font-size:11px;color:#8dbf96;min-width:34px;text-align:right}
  .admin{position:fixed;right:14px;top:14px;width:300px;background:rgba(10,10,10,0.95);border:1px solid #333;padding:12px;border-radius:10px;z-index:999;max-height:85vh;overflow:auto}
  /* Generic helper for any floating overlay that gets too tall */
  .overlay-scroll-fix{max-height:min(85vh, calc(100dvh - 28px));overflow:auto;overscroll-behavior:contain;scrollbar-gutter:stable both-edges;touch-action:pan-y}
  .overlay-scroll-fix > :first-child{position:sticky;top:0;background:rgba(10,10,10,0.98);z-index:2;padding-bottom:6px;margin-top:-4px;border-bottom:1px solid #333}
    /* Icon styling */
    .ico{display:inline-flex;align-items:center;justify-content:center;width:1.1em;height:1.1em;margin-right:6px;color:inherit}
    .ico svg{width:1em;height:1em;fill:currentColor;display:inline-block}
    .lbl{vertical-align:middle}
    /* HUD compact: hide labels in toolbar buttons */
    body.hud-compact .toolbar .lbl{display:none}
  /* Tower card hover */
  .tower-list > div:hover{filter:brightness(1.05)}
  /* Tower build button styling */
  .tower-card{display:grid;grid-template-columns:42px 1fr auto;align-items:center;gap:10px;background:var(--panel2)!important;color:var(--txt)!important;border:1px solid var(--edge)!important;border-radius:8px;padding:8px 10px;box-shadow:0 1px 8px rgba(0,0,0,.25);cursor:pointer;position:relative;overflow:hidden}
  .tower-card .tc-ico{width:42px;height:42px;display:grid;place-items:center;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));border:1px solid var(--edge);border-radius:8px}
  .tower-card .tc-ico svg{width:26px;height:26px;display:block;fill:var(--accent)}
  .tower-card .tc-name{font-weight:600}
  .tower-card .tc-sub{font-size:12px;color:var(--muted)}
  .tower-card .tc-cost{font-weight:700;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.25);padding:2px 8px;border-radius:999px;color:#fff;justify-self:end}
  .tower-card.tc-poor{opacity:.6}
  .tower-card:hover{filter:brightness(1.05)}
  /* Locked overlay */
  .tower-card .tc-lock{position:absolute;inset:0;border-radius:inherit;background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.75));display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;text-align:center;color:#eee;pointer-events:auto;z-index:2}
  .tower-card .tc-lock svg{width:26px;height:26px;fill:#ff6b6b;filter:drop-shadow(0 2px 6px rgba(0,0,0,.4))}
  .tower-card .tc-lock .tl-note{font-size:12px;font-weight:800;color:#ff8b8b;text-transform:uppercase;opacity:.95}
  .tower-card.tc-locked .tc-cost{opacity:.4}
  .tower-card.tc-locked .tc-ico svg{filter:grayscale(.3);opacity:.85}
  .tower-card.tc-locked{cursor:not-allowed}
  /* Filter bar */
  #towerFilter{display:flex;gap:6px;align-items:center;margin-top:8px;flex-wrap:wrap}
  #towerFilter input{flex:1 1 100%;min-width:0;background:#0e0e0e;border:1px solid var(--edge);border-radius:6px;padding:6px 8px;color:var(--txt)}
  #towerFilter select{flex:1 1 100%;min-width:0;background:#0e0e0e;border:1px solid var(--edge);border-radius:6px;padding:6px 8px;color:var(--txt)}
  #towerFilter .chip{background:var(--btn2);color:#fff;border-radius:999px;padding:4px 10px;border:0;cursor:pointer}
  #towerFilter .chip.active{filter:brightness(1.1)}
  .tc-badges{display:flex;gap:6px;align-items:center}
  .tc-badge{font-size:10px;line-height:1;padding:3px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.35)}
  .tc-badge.rare{background:rgba(0,128,255,.18);border-color:rgba(0,128,255,.35)}
  .tc-badge.epic{background:rgba(168,85,247,.18);border-color:rgba(168,85,247,.35)}
  .tc-tags{font-size:11px;color:var(--muted)}
  /* When cardified, hide original fallback nodes */
  #towerBtns.td-cardified > *:not(.td-cards){display:none!important}
  #towerBtns .td-cards{display:contents}
  </style>
</head>
<body>
  <!-- Inline icons to ensure file:// compatibility -->
  <svg aria-hidden="true" focusable="false" style="position:absolute;width:0;height:0;overflow:hidden" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <symbol id="i-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7-11-7z"/></symbol>
    <symbol id="i-pause" viewBox="0 0 24 24"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></symbol>
    <symbol id="i-speed" viewBox="0 0 24 24"><path d="M7 6l7 6-7 6V6zm6 0l7 6-7 6V6z"/></symbol>
    <symbol id="i-eye" viewBox="0 0 24 24"><path d="M12 5C5 5 2 12 2 12s3 7 10 7 10-7 10-7-3-7-10-7zm0 11a4 4 0 110-8 4 4 0 010 8z"/></symbol>
    <symbol id="i-bolt" viewBox="0 0 24 24"><path d="M13 2L3 14h7l-2 8 10-12h-7l2-8z"/></symbol>
    <symbol id="i-trash" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm2 2h14l-1 12H6L5 8zm5-3h4l1 2H9l1-2z"/></symbol>
    <symbol id="i-star" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.09-1.01L12 2z"/></symbol>
    <symbol id="i-wrench" viewBox="0 0 24 24"><path d="M22.7 19.3l-6.4-6.4a6 6 0 11-3.6-3.6l6.4 6.4 3.6 3.6zM7 13a4 4 0 100-8 4 4 0 000 8z"/></symbol>
    <symbol id="i-restart" viewBox="0 0 24 24"><path d="M12 5V2L8 6l4 4V7a7 7 0 11-7 7H3a9 9 0 109-9z"/></symbol>
    <symbol id="i-home" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></symbol>
  <symbol id="i-lock" viewBox="0 0 24 24"><path d="M17 9h-1V7a4 4 0 00-8 0v2H7a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2v-7a2 2 0 00-2-2zm-7-2a2 2 0 114 0v2h-4V7zm2 6a2 2 0 110 4 2 2 0 010-4z"/></symbol>
  <!-- Targeting icons used in popup -->
  <symbol id="i-first" viewBox="0 0 24 24"><path d="M4 12l6-6v4h10v4H10v4z"/></symbol>
  <symbol id="i-last" viewBox="0 0 24 24"><path d="M20 12l-6 6v-4H4v-4h10V6z"/></symbol>
  <symbol id="i-near" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></symbol>
  <symbol id="i-clear" viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-plus" viewBox="0 0 24 24"><path d="M11 5h2v6h6v2h-6v6h-2v-6H5v-2h6z"/></symbol>
  <symbol id="i-crosshair" viewBox="0 0 24 24"><path d="M11 2h2v4h-2V2zm0 16h2v4h-2v-4zM2 11h4v2H2v-2zm16 0h4v2h-4v-2z"/><circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2"/></symbol>
  <symbol id="i-gear" viewBox="0 0 24 24"><path d="M19.14 12.94a7.987 7.987 0 000-1.88l2.03-1.58-1.92-3.32-2.39.96a8.078 8.078 0 00-1.63-.94l-.36-2.54h-3.84l-.36 2.54a8.078 8.078 0 00-1.63.94l-2.39-.96-1.92 3.32 2.03 1.58a7.987 7.987 0 000 1.88l-2.03 1.58 1.92 3.32 2.39-.96c.51.39 1.06.71 1.63.94l.36 2.54h3.84l.36-2.54c.57-.23 1.12-.55 1.63-.94l2.39.96 1.92-3.32-2.03-1.58zM12 15.5A3.5 3.5 0 1112 8a3.5 3.5 0 010 7.5z"/></symbol>
    <!-- Tower thumbnails -->
    <symbol id="i-cannon" viewBox="0 0 24 24"><path d="M3 15h8l6-4-3-2-5 3H3v3zM7 18a2 2 0 110-4 2 2 0 010 4z"/></symbol>
    <symbol id="i-sniper" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 3v6M12 15v6M3 12h6M15 12h6" stroke="currentColor" stroke-width="2" fill="none"/></symbol>
    <symbol id="i-laser" viewBox="0 0 24 24"><path d="M4 12h10l3-3-3-3 7 6-7 6 3-3H4z"/></symbol>
    <symbol id="i-flame" viewBox="0 0 24 24"><path d="M12 2s5 4 5 9a5 5 0 11-10 0c0-3 2-5 5-9zm0 7c1.5 1.6 2 3 2 4a2 2 0 11-4 0c0-1 .6-2.2 2-4z"/></symbol>
    <symbol id="i-lightning2" viewBox="0 0 24 24"><path d="M13 2L5 13h6l-1 9 9-12h-6l1-8z"/></symbol>
    <symbol id="i-poison" viewBox="0 0 24 24"><path d="M12 2a5 5 0 00-5 5c0 3 5 5 5 5s5-2 5-5a5 5 0 00-5-5zm-6 18a6 6 0 1112 0H6z"/></symbol>
    <symbol id="i-freeze" viewBox="0 0 24 24"><path d="M12 2v20M2 12h20M4.2 4.2l15.6 15.6M19.8 4.2L4.2 19.8" stroke="currentColor" stroke-width="2"/></symbol>
    <symbol id="i-splash" viewBox="0 0 24 24"><path d="M4 16c3-5 7-6 9-6s5 1 7 6c-3 2-6 2-9 2s-6 0-7-2z"/></symbol>
    <symbol id="i-rocket" viewBox="0 0 24 24"><path d="M5 19l4-1 6-6 3-7-7 3-6 6-1 4 4 1zM8 16l-3 3"/></symbol>
    <symbol id="i-bank" viewBox="0 0 24 24"><path d="M12 3l9 5v2H3V8l9-5zm-8 7h16v9H4v-9zm4 2v5m4-5v5m4-5v5"/></symbol>
    <symbol id="i-buff" viewBox="0 0 24 24"><path d="M12 2l3 6 6 1-4 4 1 6-6-3-6 3 1-6-4-4 6-1 3-6z"/></symbol>
    <symbol id="i-mine" viewBox="0 0 24 24"><path d="M12 8l4 8H8l4-8zm-7 8h14v2H5z"/></symbol>
  </svg>
  <div id="app">
    <div class="sidebar">
      <div class="panel">
        <h3>Bygg torn</h3>
        <div class="small">Klicka torn och måla på kartan. Högerklick avbryter.</div>
        <div id="towerFilter">
          <input id="towerSearch" placeholder="Sök torn..." />
          <select id="towerSort">
            <option value="auto">Sortera: Standard</option>
            <option value="cost-asc">Pris ↑</option>
            <option value="cost-desc">Pris ↓</option>
            <option value="name-asc">Namn A–Ö</option>
          </select>
          <button class="chip active" data-cat="all">Alla</button>
          <button class="chip" data-cat="attack">Attack</button>
          <button class="chip" data-cat="support">Support</button>
          <button class="chip" data-cat="economy">Ekonomi</button>
        </div>
        <div class="tower-list" id="towerBtns"></div>
      </div>
      <div class="panel" id="selectedPanel">
        <h3>Valt torn</h3>
        <div class="small" id="selInfo">Inget torn valt.</div>
      </div>
    </div>
    <div class="toolbar">
      <div class="profile-chip" id="profileChip" title="Klicka för detaljer">
        <div class="pc-line"><span id="pcName">Spelare</span><span id="pcLvl" class="small">Lvl 1</span></div>
        <div class="pc-xp-row">
          <div class="xpbar"><span class="xpbar-fill" id="pcXpFill" style="width:0%"></span></div>
          <span id="pcXpPct">0%</span>
        </div>
      </div>
      <div class="stat">
  <div>Pengar: <strong id="money">100</strong></div>
  <div>SP: <strong id="skillPts">0</strong></div>
        <div>Liv: <strong id="lives">10</strong></div>
  <div>Våg: <strong id="wave">0</strong> <span id="bountyBoost" class="small" style="display:none;margin-left:6px;color:#9f6">Bounty +25%</span></div>
  <div>Rund-income: <strong id="income">0</strong></div>
        <div>Hastighet: <strong id="speedLbl">1×</strong></div>
      </div>
  <button id="startWave"><span class="ico"><svg viewBox="0 0 24 24"><use href="#i-play" xlink:href="#i-play"/></svg></span><span class="lbl">Starta våg</span></button>
  <button id="btnSpeed" class="btn-secondary"><span class="ico"><svg viewBox="0 0 24 24"><use href="#i-speed" xlink:href="#i-speed"/></svg></span><span class="lbl">×1</span></button>
  <button id="btnPause" class="btn-secondary"><span class="ico"><svg viewBox="0 0 24 24"><use href="#i-pause" xlink:href="#i-pause"/></svg></span><span class="lbl">Pausa</span></button>
  <button id="btnSettings" class="btn-secondary" title="UI-inställningar"><span class="ico"><svg viewBox="0 0 24 24"><use href="#i-gear" xlink:href="#i-gear"/></svg></span><span class="lbl">Inställningar</span></button>
  <button id="btnSkills" class="btn-secondary"><span class="ico"><svg viewBox="0 0 24 24"><use href="#i-star" xlink:href="#i-star"/></svg></span><span class="lbl">Skills</span></button>
  <a id="btnMenu" class="btn-secondary" href="./START.html" style="display:inline-block;text-decoration:none;color:inherit;padding:8px 10px;border-radius:6px;"><span class="ico"><svg viewBox="0 0 24 24"><use href="#i-home" xlink:href="#i-home"/></svg></span><span class="lbl">Meny</span></a>
    </div>
    <div class="main">
    <canvas id="canvas" width="1200" height="800"></canvas>
  <div id="buildGhost" style="position:absolute;inset:0;pointer-events:none;display:none;overflow:visible;z-index:100"></div>
  <div id="towerOverlay" style="position:absolute;inset:0;pointer-events:none;z-index:90"></div>
    </div>
    <!-- Hidden hooks so legacy event wiring stays intact after grouping tools into Settings -->
    <div id="utilityHooks" style="display:none">
      <button id="btnRanges"></button>
      <button id="btnDps"></button>
      <button id="sellAll"></button>
      <button id="btnAdmin"></button>
      <button id="btnRestart"></button>
    </div>
  </div>

  <div id="admin" class="admin hidden">
    <h3>Adminpanel</h3>
    <div class="small">Admin har flyttat. Öppna nya sidan nedan.</div>
    <a href="./ADMIN.html">Öppna Admin-sidan</a>
    <div style="margin-top:12px"><button id="closeAdmin">Stäng</button></div>
  </div>

  <script>
    // Safety: if the top toolbar is missing (e.g., moved by another script), recreate a minimal one before boot.
    (function(){
      function ensureToolbar(){
        if(document.querySelector('.toolbar')) return; // already present
        var app = document.getElementById('app'); if(!app) return;
        // Create a minimal toolbar with required IDs so game UI can wire events safely
        var tb = document.createElement('div');
        tb.className = 'toolbar';
        tb.innerHTML = '\
          <div class="profile-chip" id="profileChip" title="Klicka för detaljer">\
            <div class="pc-line"><span id="pcName">Spelare</span><span id="pcLvl" class="small">Lvl 1</span></div>\
            <div class="pc-xp-row">\
              <div class="xpbar"><span class="xpbar-fill" id="pcXpFill" style="width:0%"></span></div>\
              <span id="pcXpPct">0%</span>\
            </div>\
          </div>\
          <div class="stat">\
            <div>Pengar: <strong id="money">0</strong></div>\
            <div>SP: <strong id="skillPts">0</strong></div>\
            <div>Liv: <strong id="lives">10</strong></div>\
            <div>Våg: <strong id="wave">0</strong> <span id="bountyBoost" class="small" style="display:none;margin-left:6px;color:#9f6">Bounty +25%</span></div>\
            <div>Rund-income: <strong id="income">0</strong></div>\
            <div>Hastighet: <strong id="speedLbl">1×</strong></div>\
          </div>\
          <button id="startWave">Starta våg</button>\
          <button id="btnSpeed" class="btn-secondary">×1</button>\
          <button id="btnPause" class="btn-secondary">Pausa</button>\
          <button id="btnSettings" class="btn-secondary">Inställningar</button>\
          <button id="btnSkills" class="btn-secondary">Skills</button>\
          <a id="btnMenu" class="btn-secondary" href="./START.html" style="display:inline-block;text-decoration:none;color:inherit;padding:8px 10px;border-radius:6px;">Meny</a>';
        // Insert after sidebar to match grid area
        // If app has first child (sidebar) and main, append toolbar in between by order
        // Simpler: append as second child; grid-area CSS will place it correctly
        var sidebar = app.querySelector('.sidebar');
        if(sidebar && sidebar.nextSibling){ app.insertBefore(tb, sidebar.nextSibling); } else { app.appendChild(tb); }
      }
      // Run as soon as possible
      try{ ensureToolbar(); }catch(_e){}
      document.addEventListener('DOMContentLoaded', function(){ try{ ensureToolbar(); }catch(_e){} });
    })();
  </script>

  <!-- Skills modal (fallback UI). Will be shown when clicking "Skills". -->
  <div id="skillsModal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="skillsTitle"
       style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:520px;max-width:95vw;max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--edge);border-radius:var(--radius);z-index:1000;box-shadow:0 16px 48px rgba(0,0,0,.5)">
    <div id="skillsDragHandle" style="position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px;background:var(--panel2);border-bottom:1px solid var(--edge);cursor:move;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)">
      <div>
        <strong id="skillsTitle">Färdighetsträd</strong>
        <span class="small" id="skillsPtsLbl" style="margin-left:8px;color:var(--muted)">SP: 0</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="skillsBtnRespec" class="btn-secondary" title="Återställ alla val">Respec</button>
        <button id="skillsBtnClose" class="btn-secondary">Stäng</button>
      </div>
    </div>
    <div id="skillsTabs" style="padding:8px 12px;display:flex;gap:6px;border-bottom:1px solid var(--edge);background:var(--panel2)">
      <button class="btn-secondary" data-tab="Alla">Alla</button>
      <button class="btn-secondary" data-tab="Offensiv">Offensiv</button>
      <button class="btn-secondary" data-tab="Ekonomi">Ekonomi</button>
      <button class="btn-secondary" data-tab="Utility">Utility</button>
    </div>
    <div id="skillsBody" style="padding:12px;display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px"></div>
    <div style="padding:10px;border-top:1px solid var(--edge);background:var(--panel2)">
      <div class="small" id="skillsSummary">Inga bonusar aktiva ännu.</div>
    </div>
  </div>

  <script>
    // Lightweight Settings panel for Visuals/UI tweaks
    (function(){
      // Map new preset names to legacy ones for bundle/fallback mode
      var PRESET_MAP = {
        twinLanes: 'zigzag',
        forkMerge: 'maze',
        overpass8: 'figure8',
        spiralCore: 'riverMeander',
        switchbacks: 'zigzag',
        islands: 'riverMeander',
        portals: 'figure8',
        pockets: 'maze'
      };
      var btn = document.getElementById('btnSettings'); if(!btn) return;
  var panel = document.createElement('div');
      panel.style.cssText='position:fixed;right:14px;top:64px;z-index:1000;background:var(--panel);border:1px solid var(--edge);border-radius:var(--radius);padding:10px;min-width:260px;box-shadow:0 10px 24px rgba(0,0,0,.35)';
      panel.className='hidden';
  panel.setAttribute('data-primary-settings','1');
      panel.innerHTML = '\
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">\
          <div style="font-weight:600">Inställningar</div>\
          <button id="stClose" class="btn-secondary">Stäng</button>\
        </div>\
        <div class=\"small\" style=\"margin-top:6px\">Verktyg</div>\
        <div style="display:grid;grid-template-columns:1fr;gap:6px;margin-bottom:6px">\
          <button id=\"stToolRanges\" class=\"btn-secondary\">Visa räckvidd</button>\
          <button id=\"stToolDps\" class=\"btn-secondary\">Visa DPS</button>\
          <button id=\"stToolSellAll\" class=\"btn-secondary\">Sälj alla</button>\
          <button id=\"stToolAdmin\" class=\"btn-secondary\">Admin</button>\
          <button id=\"stToolRestart\" class=\"btn-secondary\">Restart</button>\
        </div>\
        <div class="small" style="margin-top:6px">Avancerat</div>\
        <div style="display:grid;grid-template-columns:1fr;gap:6px;margin-bottom:6px">\
          <button id="stAdvanced" class="btn-secondary">Öppna avancerade inställningar…</button>\
        </div>\
        <div class="small" style="margin-top:6px">Tema</div>\
        <select id=\"stTheme\" style=\"width:100%\">\
          <option value=\"dim\">Mörk (dim)</option>\
          <option value=\"light\">Ljus</option>\
          <option value=\"neon\">Neon</option>\
          <option value=\"matrix\">Matrix</option>\
        </select>\
        <div class="small" style="margin-top:8px">Accentfärg</div>\
        <input id="stAccent" type="color" style="width:100%" />\
        <div class="small" style="margin-top:8px">UI‑skalning</div>\
        <input id="stScale" type="range" min="0.8" max="1.4" step="0.01" style="width:100%" />\
        <div class="small">Font‑skalning</div>\
        <input id="stFont" type="range" min="0.9" max="1.3" step="0.01" style="width:100%" />\
        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px;align-items:center;margin-top:8px">\
          <label class="small">Visa alla räckvidder</label><input id="stRanges" type="checkbox" />\
          <label class="small">Visa DPS</label><input id="stDps" type="checkbox" />\
          <label class="small">Visa heatmap</label><input id="stHeat" type="checkbox" />\
          <label class="small">Dimma</label><input id="stFog" type="checkbox" />\
          <label class="small">Kompakt HUD</label><input id="stCompact" type="checkbox" />\
          <label class="small">Skadenummer</label><input id="stDmgNums" type="checkbox" />\
          <label class="small">Färre effekter</label><input id="stReduced" type="checkbox" />\
        </div>';
      document.body.appendChild(panel);
      // Suppress any legacy settings panel that auto-opens on load
      function suppressAutoLegacyPanels(){
        try{
          var app = document.getElementById('app');
          var nodes = Array.from(document.querySelectorAll('div,section,aside,article'));
          nodes.forEach(function(el){
            if(el===panel || panel.contains(el)) return; // our primary settings
            if(el===advModal || advModal.contains(el)) return;
            if(el.getAttribute('data-adv-settings')==='1') return;
            if(el.getAttribute('data-primary-settings')==='1') return;
            if(app && (el===app || el.contains(app) || app.contains(el))) return;
            var s = getComputedStyle(el);
            var isFloating = (s.position==='fixed' || s.position==='absolute');
            var hasControls = (el.querySelectorAll('input[type="range"]').length >= 2) || !!el.querySelector('input[type="color"]');
            if(!isFloating || !hasControls) return;
            var txt = (el.textContent||'').toLowerCase();
            var looksSettings = /tema|accentfärg|hörnradie|ikonstorlek|ui\s*-?\s*skala|rutnät|väg/i.test(txt);
            if(!looksSettings) return;
            // Hide it; we will expose via Advanced on demand
            el.style.display = 'none';
            el.setAttribute('data-adv-settings','1');
          });
        }catch(_e){}
      }
      // Run suppression now and for a brief window to catch late mounts
      try{ suppressAutoLegacyPanels(); }catch(_e){}
      try{
        var supStart = Date.now();
        var supObs = new MutationObserver(function(){ if(Date.now()-supStart>3500){ try{ supObs.disconnect(); }catch(_e){} return; } suppressAutoLegacyPanels(); });
        supObs.observe(document.body, {childList:true, subtree:true});
        setTimeout(function(){ try{ supObs.disconnect(); }catch(_e){} }, 4000);
      }catch(_e){}
      // Advanced settings modal host (we'll move legacy/bottom settings box here on demand)
      var advModal = document.createElement('div');
      advModal.id = 'advSettingsModal';
      advModal.className = 'hidden';
      advModal.setAttribute('role','dialog');
      advModal.setAttribute('aria-modal','true');
      advModal.style.cssText = 'position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:560px;max-width:95vw;max-height:85vh;overflow:auto;background:var(--panel);border:1px solid var(--edge);border-radius:var(--radius);z-index:1100;box-shadow:0 16px 48px rgba(0,0,0,.5)';
      advModal.innerHTML = '\
        <div id="advDrag" style="position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px;background:var(--panel2);border-bottom:1px solid var(--edge);cursor:move;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius)">\
          <strong>Avancerade inställningar</strong>\
          <button id="advClose" class="btn-secondary">Stäng</button>\
        </div>\
        <div id="advBody" style="padding:10px"></div>';
      document.body.appendChild(advModal);
      // Make draggable if helper exists
      if(window.__TD_MAKE_DRAGGABLE__) try{ window.__TD_MAKE_DRAGGABLE__(advModal, advModal.querySelector('#advDrag')); }catch(_e){}
      advModal.querySelector('#advClose')?.addEventListener('click', function(){ advModal.classList.add('hidden'); });
      window.addEventListener('pointerdown', function(e){ if(advModal.classList.contains('hidden')) return; if(e.target===advModal || advModal.contains(e.target)) return; advModal.classList.add('hidden'); });

      // Try to locate any legacy/bottom settings panel and capture it into our modal to avoid duplicates/flicker
      var legacySettingsEl = null;
      function findLegacySettings(){
        if(legacySettingsEl && document.body.contains(legacySettingsEl)) return legacySettingsEl;
        try{
          var candidates = Array.from(document.querySelectorAll('div,section,aside,article'));
          var keys = [/Hörnradie/i, /Rutnät/i, /Ikonstorlek/i, /Inställningar/i, /UI\s*-?\s*skal/i, /Tema/i, /Accent/i, /Font/i];
          candidates = candidates.filter(function(el){
            if(el.getAttribute('data-adv-settings')==='1') return true;
            // Never target the main app or its ancestors/descendants
            var app = document.getElementById('app');
            if(el===app || (app && (el.contains(app) || app.contains(el)))) return false;
            var s = getComputedStyle(el);
            // Looks like a floating/settings panel
            var looksPanel = ((s.backgroundColor && s.backgroundColor !== 'rgba(0, 0, 0, 0)') && (s.borderStyle && s.borderStyle!=='none')) || (s.position==='fixed' || s.position==='absolute');
            // Must include characteristic controls (sliders or color)
            var heavyControls = (el.querySelectorAll('input[type="range"]').length >= 2) || !!el.querySelector('input[type="color"]');
            if(!(looksPanel && heavyControls)) return false;
            var txt = (el.textContent||'').slice(0,500);
            return keys.some(function(r){ return r.test(txt); });
          });
          // Prefer elements lower on the page (the bottom box) and not our own panels
          candidates = candidates.filter(function(el){ return el!==panel && !panel.contains(el) && el!==advModal && !advModal.contains(el); });
          // Skip overly large containers (likely the whole app/content)
          candidates = candidates.filter(function(el){ var r=el.getBoundingClientRect(); return r.width <= (window.innerWidth*0.9) && r.height <= (window.innerHeight*0.9); });
          candidates.sort(function(a,b){ return a.getBoundingClientRect().top - b.getBoundingClientRect().top; });
          legacySettingsEl = candidates[candidates.length-1] || null;
          if(legacySettingsEl){ legacySettingsEl.setAttribute('data-adv-settings','1'); }
        }catch(_e){ legacySettingsEl = null; }
        return legacySettingsEl;
      }
      function attachLegacyToModal(){
        var el = findLegacySettings();
        if(!el) return false;
        try{
          // Normalize position and appearance before moving
          el.style.display='';
          var s = getComputedStyle(el);
          if(s.position==='fixed' || s.position==='absolute'){ el.style.position='static'; el.style.left=''; el.style.top=''; el.style.right=''; el.style.bottom=''; }
          el.style.maxWidth='unset'; el.style.maxHeight='unset'; el.style.margin='0';
          var body = document.getElementById('advBody'); if(body && el.parentNode!==body){ body.innerHTML=''; body.appendChild(el); }
          return true;
        }catch(_e){ return false; }
      }
      // Observe DOM for when the legacy panel is injected and capture it immediately (prevents flicker)
      // Disabled by default; only enabled after user opens Advanced once to avoid accidental grabs.
      try{
        if(localStorage.getItem('td-adv-capture')==='1'){
          attachLegacyToModal();
          var obs = new MutationObserver(function(){ attachLegacyToModal(); });
          obs.observe(document.body, {childList:true, subtree:true});
        }
      }catch(_e){}
      function read(){
        try{ return JSON.parse(localStorage.getItem('td-settings-v1')||'{}'); }catch(_e){ return {}; }
      }
      function write(fn){
        var raw = read(); raw.Visuals = raw.Visuals||{}; fn(raw.Visuals); raw.ts=Date.now(); try{ localStorage.setItem('td-settings-v1', JSON.stringify(raw)); }catch(_e){}
        apply(raw.Visuals);
      }
      function apply(v){
        try{
          var THEMES = {
            light: { '--bg':'#f5f7fb','--panel':'#ffffff','--panel2':'#f7f9fc','--edge':'#d6dbe7','--txt':'#0b1020','--muted':'#5c6680','--btn2':'#dde3f0','--accent':'#3b82f6' },
            dim:   { '--bg':'#0f0f10','--panel':'#151515','--panel2':'#101010','--edge':'#2a2a2a','--txt':'#eeeeee','--muted':'#aaaaaa','--btn2':'#3a3a3a','--accent':'#2d6' },
            neon:  { '--bg':'#0a0b14','--panel':'#0f1022','--panel2':'#0c0d1a','--edge':'#1b1c2b','--txt':'#e7f0ff','--muted':'#8ea2c6','--btn2':'#1b1e34','--accent':'#00e5ff' },
            matrix:{ '--bg':'#050805','--panel':'#0a0f0a','--panel2':'#070b07','--edge':'#132b13','--txt':'#dfffe0','--muted':'#8dbf96','--btn2':'#163b16','--accent':'#11f27a' }
          };
          var base = THEMES[(v.theme)||'dim']||THEMES.dim; var root=document.documentElement; for(var k in base){ root.style.setProperty(k, base[k]); }
          if(v._accent){ root.style.setProperty('--accent', v._accent); }
          if(typeof v._radius==='number'){ root.style.setProperty('--radius', v._radius+'px'); }
          if(typeof v._scale==='number'){ root.style.setProperty('--ui-scale', String(v._scale)); }
          if(v._compact){ document.body.classList.add('hud-compact'); } else { document.body.classList.remove('hud-compact'); }
        }catch(_e){}
      }
  function sync(){ var d=read(); var v=d.Visuals||{}; panel.querySelector('#stTheme').value = v.theme||'dim'; panel.querySelector('#stAccent').value = (v._accent||'#2dd66f'); panel.querySelector('#stScale').value = String(v._scale||1); panel.querySelector('#stFont').value = String(v.fontScale||1); panel.querySelector('#stRanges').checked=!!v.showAllRanges; panel.querySelector('#stDps').checked=!!v.showDps; panel.querySelector('#stHeat').checked=!!v.showHeatmap; panel.querySelector('#stFog').checked=!!v.fogEnabled; panel.querySelector('#stCompact').checked=!!v._compact; panel.querySelector('#stDmgNums').checked = !(v.showDamageNumbers===false); panel.querySelector('#stReduced').checked = !!v.reducedFX; }
      // Open/close
      btn.addEventListener('click', function(){ if(panel.classList.contains('hidden')){ sync(); panel.classList.remove('hidden'); } else { panel.classList.add('hidden'); } });
      panel.querySelector('#stClose').addEventListener('click', function(){ panel.classList.add('hidden'); });
      // Advanced button: show the captured legacy panel inside modal
      panel.querySelector('#stAdvanced')?.addEventListener('click', function(){
        var el = findLegacySettings();
        if(!el){
          // Gentle toast
          try{ var host=document.createElement('div'); host.style.cssText='position:fixed;left:50%;top:14px;transform:translateX(-50%);z-index:2000;background:#111a;border:1px solid #333;padding:8px 12px;border-radius:10px;color:#fff;font:12px system-ui;box-shadow:0 8px 20px rgba(0,0,0,.45)'; host.textContent='Inga avancerade inställningar hittades.'; document.body.appendChild(host); setTimeout(function(){ host.remove(); }, 2500); }catch(_e){}
          return;
        }
        try{
          // Enable capture for this session and ensure it's captured, then reveal modal
          try{ localStorage.setItem('td-adv-capture','1'); }catch(_e){}
          attachLegacyToModal();
          advModal.classList.remove('hidden');
        }catch(_e){}
      });
  // Inputs
  // Wire tool actions from inside settings panel
  panel.querySelector('#stToolRanges').addEventListener('click', function(){ try{ document.getElementById('btnRanges')?.click(); }catch(_e){} });
  panel.querySelector('#stToolDps').addEventListener('click', function(){ try{ document.getElementById('btnDps')?.click(); }catch(_e){} });
  panel.querySelector('#stToolSellAll').addEventListener('click', function(){ try{ document.getElementById('sellAll')?.click(); }catch(_e){} });
  panel.querySelector('#stToolAdmin').addEventListener('click', function(){ try{ document.getElementById('btnAdmin')?.click(); }catch(_e){} });
  panel.querySelector('#stToolRestart').addEventListener('click', function(){ try{ document.getElementById('btnRestart')?.click(); }catch(_e){} });
      panel.querySelector('#stTheme').addEventListener('change', function(){ var val=this.value; write(v=>{ v.theme=val; }); });
      panel.querySelector('#stAccent').addEventListener('input', function(){ var val=this.value; write(v=>{ v._accent=val; }); });
      panel.querySelector('#stScale').addEventListener('input', function(){ var val=parseFloat(this.value)||1; write(v=>{ v._scale=val; }); });
      panel.querySelector('#stFont').addEventListener('input', function(){ var val=parseFloat(this.value)||1; write(v=>{ v.fontScale=val; }); });
      panel.querySelector('#stRanges').addEventListener('change', function(){ var on=this.checked; write(v=>{ v.showAllRanges=on; }); });
      panel.querySelector('#stDps').addEventListener('change', function(){ var on=this.checked; write(v=>{ v.showDps=on; }); });
      panel.querySelector('#stHeat').addEventListener('change', function(){ var on=this.checked; write(v=>{ v.showHeatmap=on; }); });
      panel.querySelector('#stFog').addEventListener('change', function(){ var on=this.checked; write(v=>{ v.fogEnabled=on; }); });
      panel.querySelector('#stCompact').addEventListener('change', function(){ var on=this.checked; write(v=>{ v._compact=on; }); });
  panel.querySelector('#stDmgNums').addEventListener('change', function(){ var on=this.checked; write(v=>{ v.showDamageNumbers=on; }); });
  panel.querySelector('#stReduced').addEventListener('change', function(){ var on=this.checked; write(v=>{ v.reducedFX=on; }); });
      // Apply current on load
      try{ var v=read().Visuals||{}; apply(v); }catch(_e){}
      // Close when clicking outside
      window.addEventListener('pointerdown', function(e){ if(panel.classList.contains('hidden')) return; if(e.target===panel || panel.contains(e.target) || e.target===btn) return; panel.classList.add('hidden'); });
    })();
  </script>
  <script>
    // Profile chip opens the profile panel via a custom event consumed by the game UI
    (function(){
      var chip = document.getElementById('profileChip');
      if(chip){ chip.addEventListener('click', function(){
        try{ document.dispatchEvent(new CustomEvent('td:openProfile')); }catch(_e){}
      }); }
    })();
  </script>
  <script>
  // Robust bootstrap: prefer module; fallback only if module fails (no aggressive timeout)
    (function(){
      var loaded = false;
      function loadFallback(){
        if(loaded) return; loaded = true;
        try{ window.__TD_FALLBACK = true; }catch(_e){}
        var s = document.createElement('script');
        s.src = './dist/bundle.js';
        s.onload = function(){ window.__TD_BOOTED = true; };
        document.body.appendChild(s);
      }
  // Try module first (even on file://); if it fails, fallback to bundle
  try{
        var sm = document.createElement('script');
        sm.type = 'module';
        sm.src = './src/main.js';
        sm.onerror = loadFallback;
        document.body.appendChild(sm);
      }catch(e){ loadFallback(); }
    })();
  </script>
  <script>
    // If fallback (bundle) is active and a new preset is selected, show a tip overlay
    (function(){
      var NEW_PRESETS = new Set(['twinLanes','forkMerge','overpass8','spiralCore','switchbacks','islands','portals','pockets']);
      function readPreset(){
        try{
          var raw=localStorage.getItem('td-settings-v1');
          if(!raw) return null;
          var d=JSON.parse(raw)||{};
          var p = (d.MapSettings && d.MapSettings.preset) || null;
          if(p && PRESET_MAP[p]) return PRESET_MAP[p];
          return p;
        }catch(_e){ return null; }
      }
      function banner(){
        var host=document.createElement('div');
        host.style.cssText='position:fixed;left:50%;top:14px;transform:translateX(-50%);z-index:2000;background:#111a;border:1px solid #333;padding:8px 12px;border-radius:10px;color:#fff;font:12px system-ui;box-shadow:0 8px 20px rgba(0,0,0,.45)';
        host.textContent='Observera: fallback-läge (bundle) är aktivt. Nya kartor kräver modul-läge. Öppna via en enkel server.';
        document.body.appendChild(host);
        setTimeout(function(){ try{ host.remove(); }catch(_e){} }, 5000);
      }
      window.addEventListener('load', function(){
        var p = readPreset();
        if(window.__TD_FALLBACK && p && NEW_PRESETS.has(p)) { banner(); }
      });
    })();
  </script>
  <script>
    // Decorate dynamic popup buttons with icons even when running the fallback (file://)
    (function(){
      let scheduled = false;
      function ensureDecorated(btn, icon){
        if(!btn || btn.querySelector('.ico')) return;
        const text = btn.textContent.trim();
        const svg = '<svg viewBox="0 0 24 24"><use href="#'+icon+'" xlink:href="#'+icon+'"/></svg>';
        btn.innerHTML = '<span class="ico">'+svg+'</span><span class="lbl">'+text+'</span>';
        // keep white
        btn.style.color = '#fff';
      }
      function ensurePrice(btn){
        if(!btn) return;
        let pill = btn.querySelector('.price');
        if(!pill){
          pill = document.createElement('span'); pill.className='price'; pill.style.marginLeft='8px'; pill.style.padding='2px 6px'; pill.style.borderRadius='10px'; pill.style.background='rgba(0,0,0,0.35)'; pill.style.border='1px solid rgba(255,255,255,0.35)'; pill.style.color='#fff'; pill.style.fontWeight='600'; pill.style.fontSize='12px'; btn.appendChild(pill);
        }
        // Try to read the matching left label for price, falling back to numbers in button text
        var id = btn.id; var key = id==='ppDmg'?'cLblD':id==='ppRange'?'cLblR':id==='ppRate'?'cLblRt':null;
        if(key){ var lab=document.getElementById(key); if(lab){ var m=/\((\d+)\)/.exec(lab.textContent||''); if(m){ if(pill.textContent!==m[1]) pill.textContent=m[1]; return; } } }
        var m2=/(\d+)/.exec(btn.textContent||''); if(m2){ if(pill.textContent!==m2[1]) pill.textContent=m2[1]; } else { if(!pill.textContent) pill.textContent = '0'; }
      }
      function tick(){
        // Upgrade popup buttons
  ensureDecorated(document.getElementById('ppDmg'), 'i-plus'); ensurePrice(document.getElementById('ppDmg'));
  ensureDecorated(document.getElementById('ppRange'), 'i-plus'); ensurePrice(document.getElementById('ppRange'));
  ensureDecorated(document.getElementById('ppRate'), 'i-plus'); ensurePrice(document.getElementById('ppRate'));
        ensureDecorated(document.getElementById('ppSell'), 'i-trash');
        // Targeting
        ensureDecorated(document.getElementById('tgtFirst'), 'i-first');
        ensureDecorated(document.getElementById('tgtLast'), 'i-last');
        ensureDecorated(document.getElementById('tgtStrong'), 'i-star');
        ensureDecorated(document.getElementById('tgtClose'), 'i-near');
        ensureDecorated(document.getElementById('btnClearFocus'), 'i-clear');
      }
      // Lightweight updater: poll at a low frequency instead of observing all DOM mutations
      window.addEventListener('load', ()=>{
        try{ tick(); }catch(_e){}
        setInterval(()=>{ try{ tick(); }catch(_e){} }, 300);
      });
    })();
  </script>
  <script>
    // Tower build list enhancer: rebuilds a clean card view from the game's original nodes, hides originals to avoid duplicates.
    (function(){
      const list = document.getElementById('towerBtns');
      const moneyEl = document.getElementById('money');
      const search = document.getElementById('towerSearch');
      const sortSel = document.getElementById('towerSort');
      const filterEl = document.getElementById('towerFilter');
      let listObserver = null; let mutating=false;
      const iconFor = (name)=>{
        const n = (name||'').toLowerCase();
        if(/sniper|precision|prick/.test(n)) return 'i-sniper';
        if(/laser|beam|stråle/.test(n)) return 'i-laser';
        if(/flame|eld|fire|bränn/.test(n)) return 'i-flame';
        if(/shock|chain|blixt|tesla|kedja/.test(n)) return 'i-lightning2';
        if(/poison|acid|gift/.test(n)) return 'i-poison';
        if(/freeze|ice|frost/.test(n)) return 'i-freeze';
        if(/splash|aoe|bomb|splas/.test(n)) return 'i-splash';
        if(/rocket|missile|raket/.test(n)) return 'i-rocket';
        if(/bank|income|farm|ekonomi|peng|guld/.test(n)) return 'i-bank';
        if(/buff|aura|support|stöd/.test(n)) return 'i-buff';
        if(/mine|trap|min/.test(n)) return 'i-mine';
        return 'i-cannon';
      };
      function currentMoney(){ return parseInt(moneyEl?.textContent||'0',10)||0; }
      function collectSource(){
        const src = [];
        if(!list) return src;
        const btns = Array.from(list.querySelectorAll('button'));
        if(btns.length===0) return src; // wait until game populated
        // Now that we have content, mark as cardified and hide originals
    list.classList.add('td-cardified');
    window.__TD_ICON_FOR = iconFor;
        for(const btn of btns){
          const info = (btn.nextElementSibling && btn.nextElementSibling.classList && btn.nextElementSibling.classList.contains('small')) ? btn.nextElementSibling : null;
          btn.style.display='none'; if(info) info.style.display='none';
          src.push({btn, info});
        }
        return src;
      }
  function buildCard(obj){
        const label = (obj.btn.textContent||'').trim();
        const mCost = /(\(\d+\))|(\d+)$/.exec(label);
        let cost = 0; if(mCost){ const s = mCost[0].replace(/[()]/g,''); cost = parseInt(s,10)||0; }
        const nameOnly = label.replace(/\s*\(\d+\)\s*/,'').replace(/^\d+\s+/, '');
        const infoTxt = (obj.info? obj.info.textContent : '')||'';
        // Lock status via engine helper (fallback-safe if missing)
        let locked = false, lockedNote = '';
        try{ const res = (window.__TD_IS_LOCKED && window.__TD_IS_LOCKED(nameOnly)) || null; if(res && res.locked){ locked=true; lockedNote = res.reason || ''; } }catch(_e){}
        const tags=[];
        const d = /DMG[: ]([\d.]+)/i.exec(infoTxt); if(d) tags.push('DMG '+d[1]);
        const r = /RNG[: ](\d+)/i.exec(infoTxt); if(r) tags.push('RNG '+r[1]);
        const f = /ROF[: ]([\d.]+)s?/i.exec(infoTxt); if(f) tags.push('ROF '+f[1]+'s');
        const inc = /Income[: ](\d+)/i.exec(infoTxt); if(inc) tags.push('+'+inc[1]+'/våg');
        let badgeHtml = '';
        let cat = 'attack';
        if(/bank|income|farm|ekonomi|peng|guld/i.test(nameOnly)) { cat='economy'; badgeHtml += '<span class="tc-badge rare">Ekonomi</span>'; }
        else if(/aura|buff|support|stöd/i.test(nameOnly)) { cat='support'; }
        if(/kedja|rocket|laser|sniper/i.test(nameOnly)) badgeHtml += '<span class="tc-badge">T2</span>';
        const card = document.createElement('div'); card.className='tower-card'; card.setAttribute('data-cost', String(cost||0)); card.setAttribute('data-cat', cat); card.setAttribute('data-icon', iconFor(nameOnly));
        const overlay = locked ? (
          '<div class="tc-lock" role="note" aria-label="Låst">'
          +   '<svg viewBox="0 0 24 24"><use href="#i-lock" xlink:href="#i-lock"/></svg>'
          +   '<div class="tl-note">Låses upp vid '+(lockedNote||'VÅG')+'</div>'
          + '</div>'
        ) : '';
        card.innerHTML = '<div class="tc-ico"><svg viewBox="0 0 24 24"><use href="#'+iconFor(nameOnly)+'" xlink:href="#'+iconFor(nameOnly)+'"/></svg></div>'
          + '<div><div class="tc-name">'+nameOnly+' <span class="tc-badges">'+badgeHtml+'</span></div>'
          + '<div class="tc-tags">'+(tags.join(' • ')||'Välj och placera på kartan')+'</div></div>'
          + '<div class="tc-cost" '+(locked?'style="opacity:.5"':'')+'>'+(cost||0)+'</div>'
          + overlay;
        card.addEventListener('click', ()=> { if(locked) return; try{ obj.btn.click(); }catch(_){} });
        card.classList.toggle('tc-poor', cost>0 && currentMoney()<cost);
  if(locked){ card.classList.add('tc-locked'); card.setAttribute('aria-disabled','true'); }
        return card;
      }
      function render(){
        if(!list || mutating) return; mutating=true;
        try{
          if(listObserver) try{ listObserver.disconnect(); }catch(_e){}
          const src = collectSource();
          if(src.length===0){
            // Nothing to build yet; keep originals visible and try later
            list.classList.remove('td-cardified');
            return;
          }
          // ensure container
          let wrap = list.querySelector('.td-cards');
          if(!wrap){ wrap = document.createElement('div'); wrap.className='td-cards'; list.appendChild(wrap); }
          // build all cards fresh
          const cards = src.map(buildCard);
          // filter + sort
          const q = (search?.value||'').trim().toLowerCase();
          const activeChip = filterEl?.querySelector('.chip.active');
          const cat = activeChip? activeChip.getAttribute('data-cat') : 'all';
          const mode = sortSel?.value||'auto';
          let filtered = cards.filter(card=>{
            const name = card.querySelector('.tc-name')?.textContent.toLowerCase()||'';
            let ok = !q || name.includes(q);
            if(ok && cat && cat!=='all') ok = (card.getAttribute('data-cat')||'attack')===cat;
            return ok;
          });
          if(filtered.length===0 && (!q) && (cat==='all')) filtered = cards.slice();
          filtered.sort((a,b)=>{
            if(mode==='name-asc') return (a.querySelector('.tc-name')?.textContent||'').localeCompare(b.querySelector('.tc-name')?.textContent||'');
            const ca = parseInt(a.getAttribute('data-cost')||'0',10)||0;
            const cb = parseInt(b.getAttribute('data-cost')||'0',10)||0;
            if(mode==='cost-asc') return ca-cb;
            if(mode==='cost-desc') return cb-ca;
            return 0;
          });
          // paint
          wrap.innerHTML='';
          filtered.forEach(c=>wrap.appendChild(c));
        }catch(_e){}
        finally{
          try{ if(!listObserver) listObserver = new MutationObserver(()=>{ if(mutating) return; render(); updateAffordability(); }); }catch(_e){}
          try{ listObserver.observe(list, {childList:true, subtree:true}); }catch(_e){}
          mutating=false;
        }
      }
      function updateAffordability(){
        if(!list) return; const money = currentMoney(); const cards = list.querySelectorAll('.tower-card');
        cards.forEach(c=>{ const cost = parseInt(c.getAttribute('data-cost')||'0',10)||0; c.classList.toggle('tc-poor', cost>0 && money<cost); });
      }
      // Observe list/money
      listObserver = new MutationObserver(()=>{ if(mutating) return; render(); updateAffordability(); });
      if(list) listObserver.observe(list, {childList:true, subtree:true});
      const moneyObs = new MutationObserver(updateAffordability);
      if(moneyEl) moneyObs.observe(moneyEl, {childList:true, characterData:true, subtree:true});
      // Wire search/filter
      search?.addEventListener('input', render);
      filterEl?.addEventListener('click', (e)=>{ const b = e.target.closest('.chip'); if(!b) return; filterEl.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); b.classList.add('active'); render(); });
      sortSel?.addEventListener('change', render);
      // Initial pass (after a short delay to let fallback/module populate towers)
      window.addEventListener('load', ()=>{ setTimeout(()=>{ render(); updateAffordability(); }, 300); });
    })();
  </script>
  <script>
    // Build ghost: show a subtle ghost dot at pointer when a tower is selected; hide on right-click or after placement.
    (function(){
      const ghost = document.getElementById('buildGhost');
      const canvas = document.getElementById('canvas');
      if(!ghost || !canvas) return;
  let active=false; let iconId='i-cannon';
  // Require explicit tool selection before the first placement
  let hasToolSelected = false; // becomes true when a tower card is clicked or a numeric hotkey is pressed
  let hinted = false; // one-time hint flag
      // Guard: until the player selects a tower, ignore canvas clicks to prevent accidental build on fresh start
      function guardPlace(ev){
        if(hasToolSelected) return; // allow once a tool is chosen
        // Only intercept genuine canvas interactions
        ev.stopPropagation();
        ev.preventDefault();
        // One-time subtle hint
        if(!hinted){
          hinted = true;
          try{
            const host = document.createElement('div');
            host.textContent = 'Välj ett torn i listan först.';
            host.style.cssText = 'position:fixed;left:16px;bottom:16px;padding:8px 10px;background:rgba(0,0,0,.8);border:1px solid #333;border-radius:8px;color:#fff;font:12px system-ui;z-index:1100;';
            document.body.appendChild(host);
            setTimeout(()=>{ if(host && host.parentNode) host.remove(); }, 1800);
          }catch(_e){}
        }
      }
  canvas.addEventListener('pointerdown', guardPlace, true);
  canvas.addEventListener('mousedown', guardPlace, true);
  canvas.addEventListener('click', guardPlace, true);
  canvas.addEventListener('touchstart', guardPlace, {capture:true, passive:false});
      // When a tower card is clicked, pick up its icon
      document.getElementById('towerBtns')?.addEventListener('click', (e)=>{
        // Ignore clicks on locked overlays or locked cards entirely
        if(e.target.closest('.tc-lock')) return;
        const card = e.target.closest('.tower-card'); if(!card) return;
        if(card.classList.contains('tc-locked')) return;
        iconId = card.getAttribute('data-icon') || (window.__TD_ICON_FOR? window.__TD_ICON_FOR(card.textContent) : 'i-cannon');
  var r = canvas.getBoundingClientRect();
  var cssScale = (r.width / canvas.width) || 1;
  var gs = Math.round((window.__TD_ICON_SIZE || 32) * cssScale);
  ghost.innerHTML = '<svg viewBox="0 0 24 24" width="'+gs+'" height="'+gs+'" style="position:absolute;transform:translate(-50%,-50%);filter:drop-shadow(0 0 2px rgba(0,0,0,.5));fill:var(--accent);pointer-events:none"><use href="#'+iconId+'" xlink:href="#'+iconId+'"/></svg>';
        active=true; ghost.style.display='block';
        hasToolSelected = true;
      });
      // Numeric hotkeys (1-9) also count as selecting a tool
      window.addEventListener('keydown', (e)=>{
        const k = e.key;
        if(k && /^(?:[1-9])$/.test(k)){
          hasToolSelected = true;
        }
      }, {capture:true});
      window.addEventListener('contextmenu', ()=>{ active=false; ghost.style.display='none'; });
  canvas.addEventListener('click', ()=>{ if(!active) return; active=false; ghost.style.display='none'; });
      // On first load, cancel any pre-selected build state from the engine
      window.addEventListener('load', ()=>{
        setTimeout(()=>{
          try{
            const preventOnce = (ev)=>{ ev.preventDefault(); };
            canvas.addEventListener('contextmenu', preventOnce, {once:true});
            const evt = new MouseEvent('contextmenu', {bubbles:true, cancelable:true, view: window});
            canvas.dispatchEvent(evt);
          }catch(_e){}
          try{
            const esc = new KeyboardEvent('keydown', {key:'Escape', code:'Escape', keyCode:27, which:27, bubbles:true});
            document.dispatchEvent(esc);
          }catch(_e){}
          active=false; ghost.style.display='none';
        }, 200);
      });
      window.addEventListener('mousemove', (e)=>{
  if(!active) return;
  const cr = canvas.getBoundingClientRect();
  const or = ghost.getBoundingClientRect();
  const cssScale = (cr.width / canvas.width) || 1;
  const cx = Math.min(Math.max(e.clientX, cr.left), cr.right);
  const cy = Math.min(Math.max(e.clientY, cr.top ), cr.bottom);
  // Convert to canvas pixels
  const localX = (cx - cr.left) / cssScale;
  const localY = (cy - cr.top)  / cssScale;
  // Snap to tile centers
  const TILE = 40;
  const sx = Math.floor(localX / TILE) * TILE + TILE/2;
  const sy = Math.floor(localY / TILE) * TILE + TILE/2;
  // Convert back to overlay-local pixels and compensate for canvas border
  const cs = getComputedStyle(canvas);
  const bL = parseFloat(cs.borderLeftWidth)||0;
  const bT = parseFloat(cs.borderTopWidth)||0;
  const vx = (cr.left - or.left) + bL + sx * cssScale;
  const vy = (cr.top  - or.top ) + bT + sy * cssScale;
  const el = ghost.firstElementChild; if(!el) return; el.style.left = vx + 'px'; el.style.top  = vy + 'px';
      });
    })();
  </script>
  <script>
    // Dev overlay scroll fix: ensure the "Dev-verktyg (fallback)" panel is scrollable on small screens
    (function(){
      function applyScrollFix(){
        // Common IDs/classes the fallback uses for the dev panel container
        var candidates = [
          document.getElementById('devPanel'),
          document.querySelector('.dev-panel'),
          document.querySelector('#adminDev'),
          document.querySelector('.admin-dev'),
          // Fallback generic: the largest floating panel near top-right
          (function(){
            var all = Array.from(document.querySelectorAll('div'));
            return all.find(el=>{
              var s = getComputedStyle(el);
              if(!(s.position==='fixed' || s.position==='absolute')) return false;
              // near right/top and looks like a panel
              var rect = el.getBoundingClientRect();
              if(rect.left < window.innerWidth/2) return false;
              if(rect.top > window.innerHeight/2) return false;
              return (s.backgroundColor && s.backgroundColor !== 'rgba(0, 0, 0, 0)') && (s.borderStyle && s.borderStyle!=='none');
            }) || null;
          })()
        ].filter(Boolean);
        if(candidates.length){
          candidates.forEach(function(el){
            el.classList.add('overlay-scroll-fix');
            // Also shrink inner content margins a bit for more room
            el.style.paddingRight = '10px';
          });
          return true;
        }
        return false;
      }
      // Try immediately and then again after fallback UI is mounted
      if(!applyScrollFix()){
        var tries = 0; var h = setInterval(function(){
          tries++; if(applyScrollFix() || tries>20){ clearInterval(h); }
        }, 250);
      }
      // Re-apply on resize (mobile keyboard/rotation)
      window.addEventListener('resize', function(){ applyScrollFix(); });
    })();
  </script>
  <script>
    // Generic drag helper for any floating element
    (function(){
      function makeDraggable(el, handle){
        if(!el) return; handle = handle || el;
        let dragging=false, sx=0, sy=0, sl=0, st=0;
        function start(e){
          dragging=true; const p = ('touches' in e)? e.touches[0] : e;
          sx = p.clientX; sy = p.clientY;
          // If element is centered with transform, convert to absolute left/top
          const rect = el.getBoundingClientRect();
          el.style.left = rect.left+window.scrollX+ 'px';
          el.style.top  = rect.top +window.scrollY+ 'px';
          el.style.transform = 'none';
          sl = parseFloat(el.style.left)||0; st = parseFloat(el.style.top)||0;
          document.addEventListener('mousemove', move);
          document.addEventListener('mouseup', end);
          document.addEventListener('touchmove', move, {passive:false});
          document.addEventListener('touchend', end);
          e.preventDefault();
        }
        function move(e){
          if(!dragging) return; const p = ('touches' in e)? e.touches[0] : e;
          const dx = p.clientX - sx; const dy = p.clientY - sy;
          el.style.left = (sl + dx) + 'px';
          el.style.top  = (st + dy) + 'px';
          if('touches' in e) e.preventDefault();
        }
        function end(){ dragging=false;
          document.removeEventListener('mousemove', move);
          document.removeEventListener('mouseup', end);
          document.removeEventListener('touchmove', move);
          document.removeEventListener('touchend', end);
        }
        handle.addEventListener('mousedown', start);
        handle.addEventListener('touchstart', start, {passive:false});
      }
      window.__TD_MAKE_DRAGGABLE__ = makeDraggable;
    })();
  </script>
  <script>
    // Minimal, offline-safe skill system (fallback). Emits 'td:skillsChanged' with aggregated effects.
    (function(){
      const KEY = 'td-skills-v1';
      const D = [
        {id:'dmg',   name:'Skada +5%',        desc:'+5% tornskada per nivå',     cost:1, max:5, cat:'Offensiv', eff:{dmg:0.05}},
        {id:'rate',  name:'Eldhast. +4%',     desc:'+4% eldhastighet per nivå',  cost:1, max:5, cat:'Offensiv', eff:{rate:0.04}},
        {id:'range', name:'Räckvidd +4%',      desc:'+4% räckvidd per nivå',      cost:1, max:5, cat:'Offensiv', eff:{range:0.04}},
        {id:'inc',   name:'Income +10%',       desc:'+10% runda‑income',          cost:2, max:3, cat:'Ekonomi',  eff:{income:0.10}},
        {id:'refund',name:'Återbäring +5%',    desc:'+5% tillbaka vid försäljning',cost:1,max:3, cat:'Ekonomi',  eff:{refund:0.05}},
        {id:'spdrip',name:'SP‑drip',           desc:'+10% chans på extra SP vid våg',cost:2,max:2,cat:'Utility',  eff:{spdrip:0.10}},
        // Example of a tier-2 node with prerequisite
        {id:'overclock', name:'Övervarvning', desc:'Aktiv: tillfällig +30% eldhastighet (WIP)', cost:3, max:1, cat:'Utility', eff:{}, req:{rate:3}}
      ];
  const modal = document.getElementById('skillsModal');
  const body  = document.getElementById('skillsBody');
  const lblPts= document.getElementById('skillsPtsLbl');
  const tabs  = document.getElementById('skillsTabs');
  const btnClose = document.getElementById('skillsBtnClose');
  const btnRespec= document.getElementById('skillsBtnRespec');
  const handle   = document.getElementById('skillsDragHandle');
  const btnOpen  = document.getElementById('btnSkills');
      let state = load();
      let activeTab = 'Alla';

      // Wire open/close
      function open(){ center(modal); render(); modal.classList.remove('hidden'); updateSummary(); }
      function close(){ modal.classList.add('hidden'); save(); dispatch(); }
      btnClose.addEventListener('click', close);
      btnRespec.addEventListener('click', ()=>{ state.levels={}; save(); render(); updateSummary(); dispatch(); });
      // Toggle our modal on click; also add a document-level capture handler to pre-empt legacy handlers
      if(btnOpen){
        const toggle = (e)=>{ e.preventDefault(); e.stopPropagation(); modal.classList.contains('hidden')? open(): close(); };
        btnOpen.addEventListener('click', toggle);
      }
      document.addEventListener('click', (e)=>{
        const hit = e.target && (e.target.closest ? e.target.closest('#btnSkills') : null);
        if(!hit) return;
        e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_e){}
        modal.classList.contains('hidden')? open(): close();
      }, true);
      // Resilient: re-bind if the toolbar/buttons get re-rendered
      function bindSkillsButton(){
        const el = document.getElementById('btnSkills');
        if(!el || el.dataset.skillBound==='1') return;
        el.dataset.skillBound = '1';
        // No-op: document capture handler handles toggling reliably
      }
      bindSkillsButton();
      try{
        const obsBtn = new MutationObserver(()=> bindSkillsButton());
        obsBtn.observe(document.body, {childList:true, subtree:true});
      }catch(_e){}
      // Tabs
      tabs?.addEventListener('click', (e)=>{
        const b = e.target.closest('button[data-tab]'); if(!b) return;
        activeTab = b.getAttribute('data-tab');
        for(const el of tabs.querySelectorAll('button')) el.style.filter = '';
        b.style.filter = 'brightness(1.1)';
        render();
      });

      // Make draggable
      if(window.__TD_MAKE_DRAGGABLE__) window.__TD_MAKE_DRAGGABLE__(modal, handle);

      function center(el){ el.style.left='50%'; el.style.top='50%'; el.style.transform='translate(-50%,-50%)'; }

      function load(){
        let stored = {};
        try{ stored = JSON.parse(localStorage.getItem(KEY)||'{}'); }catch{}
        return { sp: stored.sp ?? readSpFromHud(), levels: stored.levels || {} };
      }
      function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
      function readSpFromHud(){ const el = document.getElementById('skillPts'); return el? (parseInt(el.textContent||'0',10)||0): 0; }
      // Keep SP in sync with HUD if game changes it
      const spHud = document.getElementById('skillPts');
      if(spHud){ const obs = new MutationObserver(()=>{ const v = readSpFromHud(); if(v!==state.sp){ state.sp=v; save(); render(); updateSummary(); dispatch(); }}); obs.observe(spHud, {childList:true, characterData:true, subtree:true}); }

      function spent(){ return Object.entries(state.levels).reduce((s,[id,l])=>{ const def=D.find(d=>d.id===id); return s + (def? def.cost*l : 0); },0); }
      function available(){ return Math.max(0, state.sp - spent()); }

      function meetsReq(def){
        if(!def.req) return true; for(const [id,need] of Object.entries(def.req)){ if((state.levels[id]||0) < need) return false; }
        return true;
      }
      function render(){
        body.innerHTML = '';
        lblPts.textContent = 'SP: ' + available();
        D.forEach(def=>{
          if(activeTab!=='Alla' && def.cat!==activeTab) return;
          const lvl = state.levels[def.id]||0;
          const reqOk = meetsReq(def);
          const can = available()>=def.cost && lvl<def.max && reqOk;
          const card = document.createElement('div');
          card.style.cssText='background:var(--panel2);border:1px solid var(--edge);border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:6px;min-height:90px;';
          card.innerHTML = '<div style="display:flex;justify-content:space-between;gap:6px;align-items:center">'
            + '<div><strong>'+def.name+'</strong><div class="small" style="color:var(--muted)">'+def.desc+'</div></div>'
            + '<div class="small" style="text-align:right">Kostnad: '+def.cost+'<br/>Nivå: <strong>'+lvl+'/'+def.max+'</strong>'+(def.req?'<br/><span '+(reqOk?'':'style="color:#f88"')+'>Krav: '+Object.entries(def.req).map(([k,v])=>k+' '+v).join(', ')+'</span>':'')+'</div>'
            + '</div>'
            + '<div style="display:flex;gap:6px">'
            +   '<button class="btn-secondary" data-act="dec" '+(lvl?'' : 'disabled')+'>-</button>'
            +   '<button data-act="inc" '+(can?'' : 'disabled')+' '+(reqOk?'':'title="Uppfyll kraven först"')+'>Köp</button>'
            + '</div>';
          card.querySelector('[data-act="inc"]').addEventListener('click', ()=>{ if(available()>=def.cost && (state.levels[def.id]||0)<def.max){ state.levels[def.id]=(state.levels[def.id]||0)+1; save(); render(); updateSummary(); }});
          card.querySelector('[data-act="dec"]').addEventListener('click', ()=>{ if((state.levels[def.id]||0)>0){ state.levels[def.id]--; save(); render(); updateSummary(); }});
          body.appendChild(card);
        });
      }

      function aggregate(){
        const agg = {dmg:0, rate:0, range:0, income:0, refund:0, spdrip:0};
        for(const [id,l] of Object.entries(state.levels)){
          const d = D.find(x=>x.id===id); if(!d||!l) continue;
          for(const [k,v] of Object.entries(d.eff)) agg[k] += v*l;
        }
        return agg;
      }
      function updateSummary(){
        const a = aggregate();
        const bits = [];
        if(a.dmg) bits.push('Skada +' + Math.round(a.dmg*100) + '%');
        if(a.rate) bits.push('Eldhast. +' + Math.round(a.rate*100) + '%');
        if(a.range) bits.push('Räckvidd +' + Math.round(a.range*100) + '%');
        if(a.income) bits.push('Income +' + Math.round(a.income*100) + '%');
        if(a.refund) bits.push('Återbäring +' + Math.round(a.refund*100) + '%');
        if(a.spdrip) bits.push('SP‑drip +' + Math.round(a.spdrip*100) + '%');
        document.getElementById('skillsSummary').textContent = bits.length? bits.join(' · ') : 'Inga bonusar aktiva ännu.';
        lblPts.textContent = 'SP: ' + available();
      }
      function dispatch(){
        const detail = { levels: {...state.levels}, effects: aggregate(), available: available(), spent: spent(), total: state.sp };
        window.TD_SKILLS = detail;
        try{ window.dispatchEvent(new CustomEvent('td:skillsChanged', {detail})); }catch{}
      }

      // Suppress any legacy skills mini-popup that might be created by the engine
      function killOldSkills(){
        try{
          const nodes = Array.from(document.querySelectorAll('div,aside,section,article'));
          nodes.forEach(el=>{
            if(el.getAttribute('data-legacy-hidden')==='skills') return;
            const s = getComputedStyle(el);
            if(!(s.position==='fixed' || s.position==='absolute')) return;
            const rect = el.getBoundingClientRect();
            if(rect.left < window.innerWidth/3) return; // right-ish
            if(rect.top > window.innerHeight/2) return;   // upper half only
            const txt = (el.textContent||'').trim();
            if(/Skills\s*\(\d+\)/i.test(txt) || /Klicka för att spendera/i.test(txt)){
              el.style.display = 'none';
              el.setAttribute('data-legacy-hidden','skills');
            }
          });
        }catch(_e){}
      }
      const skillsHideObs = new MutationObserver(()=> killOldSkills());
      try{ skillsHideObs.observe(document.body, {childList:true, subtree:true}); }catch(_e){}
      window.addEventListener('load', ()=>{ setTimeout(killOldSkills, 200); });

      // Initialize quietly (don’t show modal). Consumers can read window.TD_SKILLS.
      render(); updateSummary(); dispatch(); killOldSkills();
    })();
  </script>
</body>
</html>
